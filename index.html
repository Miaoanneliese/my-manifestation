<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的生活・投資手帖</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&family=Noto+Sans+TC:wght@300;400;500&family=Material+Icons+Round&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
      :root { --bg-color: #F7F7F2; --card-bg: #FFFFFF; --text-main: #404040; --text-sub: #7F7F7F; --border-color: #E0E0E0; --muji-red: #7F0019; --muji-green: #6c8c6e; --accent-brown: #8D8170; --btn-green: #597e5d; --table-header-bg: #f2f0eb; }
      * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
      body { margin: 0; font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: var(--text-main); padding-bottom: 80px; }
      header { background-color: var(--bg-color); padding: 25px 20px 10px; }
      .date-weather-box { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid var(--text-main); padding-bottom: 10px; }
      .current-date { font-family: 'Noto Serif TC', serif; font-size: 1.5rem; font-weight: 900; }
      .day-tag { font-size: 0.9rem; margin-left: 5px; color: var(--text-sub); }
      .weather-info { display: flex; align-items: center; font-size: 0.9rem; color: var(--text-sub); gap: 5px; }
      main { padding: 20px; }
      
      .muji-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 15px 20px; margin-bottom: 15px; position: relative; box-shadow: none; display: flex; flex-direction: column; }
      .card-label { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 8px; letter-spacing: 1px; font-weight: 500; }
      .muji-title { font-family: 'Noto Serif TC', serif; font-size: 1.4rem; margin: 10px 0 20px; text-align: center; color: var(--muji-red); }
      .big-number { font-size: 1.6rem; font-weight: 300; font-family: 'Noto Serif TC', serif; }
      
      .dashboard-grid { display: flex; gap: 10px; margin-bottom: 15px; align-items: stretch; }
      .schedule-card { flex: 3; margin-bottom: 0; }
      .right-col { flex: 2; display: flex; flex-direction: column; gap: 10px; }
      .goal-card, .quote-card { flex: 1; margin-bottom: 0; }
      
      /* --- 修改後的 Goal Card 樣式 (三層架構) --- */
      .goal-card { padding: 0 !important; overflow: hidden; } /* 覆蓋預設 padding */
      
      .goal-header-group { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px 8px; border-bottom: 1px solid #eee; flex-shrink: 0; }
      .cycle-badge { background-color: var(--muji-red); color: white; font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; font-weight: 500; letter-spacing: 0.5px; box-shadow: 0 1px 3px rgba(127,0,25,0.2); }
      
      .macro-goal-container { background-color: #fafafa; padding: 10px 15px; border-bottom: 1px solid #eee; flex-shrink: 0; }
      .macro-row { display: flex; align-items: baseline; margin-bottom: 6px; }
      .macro-row:last-child { margin-bottom: 0; }
      .macro-label { font-size: 0.7rem; color: #fff; background-color: var(--accent-brown); padding: 1px 6px; border-radius: 2px; margin-right: 8px; flex-shrink: 0; letter-spacing: 1px; font-weight: 400; }
      .macro-label.season { background-color: #9aa5b1; /* 區分季度的灰色 */ }
      .macro-text { font-family: 'Noto Serif TC', serif; font-size: 0.85rem; color: var(--text-main); line-height: 1.4; letter-spacing: 0.5px; }

      .cycle-list-container { flex: 1; overflow-y: auto; padding: 5px 15px 12px; min-height: 0; }
      .cycle-list-container::-webkit-scrollbar { width: 4px; } 
      .cycle-list-container::-webkit-scrollbar-thumb { background-color: #eee; border-radius: 4px; }
      
      .cycle-list-item { padding: 8px 0; border-bottom: 1px dashed #eee; display: flex; align-items: flex-start; }
      .cycle-list-item:last-child { border-bottom: none; }
      .cycle-cat { color: var(--muji-red); font-weight: 600; margin-right: 8px; white-space: nowrap; font-size: 0.8rem; margin-top: 1px; min-width: 32px; }
      .cycle-desc { color: #555; font-size: 0.85rem; line-height: 1.5; }

      /* --- Quote Card 樣式 --- */
      .quote-text { font-family: 'Noto Serif TC', serif; font-size: 0.85rem; line-height: 1.4; color: var(--accent-brown); flex: 1; display: flex; align-items: center; }

      .dashboard-main-grid { display: grid; grid-template-columns: 1fr 55px 1fr 55px; gap: 10px; align-items: stretch; }
      .dashboard-main-grid > * { min-width: 0; } 
      .dashboard-main-grid .muji-card, .dashboard-main-grid .action-btn-container { margin-bottom: 0; height: 100%; }
      .grid-left-block { grid-column: 1 / 3; } .grid-right-block { grid-column: 3 / 5; } .grid-full-width { grid-column: 1 / 5; }
      .grid-c1 { grid-column: 1; } .grid-c2 { grid-column: 2; } .grid-c3 { grid-column: 3; } .grid-c4 { grid-column: 4; }
      
      .left-stack-wrapper { display: flex; flex-direction: column; gap: 10px; height: 100%; }
      .left-stack-wrapper .muji-card:last-child { flex: 1; }
      
      .routine-wrapper { flex: 1; overflow-y: visible; min-height: 0; padding-right: 2px; display: flex; flex-direction: column; gap: 10px; }
      .routine-wrapper .muji-card { margin-bottom: 0; border: none; box-shadow: none; padding: 0; }

      .expense-display { display: flex; flex-direction: column; justify-content: center; min-width: 0; }
      .action-btn-container { width: 55px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-decoration: none; }
      .action-btn-container:active { transform: scale(0.95); }
      .record-btn { background: var(--muji-red); color: white; }
      .link-btn { background: var(--btn-green); color: white; }
      .btn-icon span { font-size: 26px; margin-bottom: 2px; }
      .btn-text { font-size: 0.75rem; letter-spacing: 1px; writing-mode: vertical-rl; text-orientation: upright; }
      
      .gratitude-compact { display: flex; flex-direction: row; gap: 8px; align-items: center; margin-top: auto; padding-top: 8px; border-top: 1px solid #f0f0f0; }
      .input-underline { flex: 1; border: none; border-bottom: 1px solid #ddd; background: transparent; padding: 4px 0; font-size: 0.9rem; border-radius: 0; outline: none; transition: border-color 0.3s; }
      .input-underline:focus { border-bottom-color: var(--accent-brown); }
      .btn-mini-muji { padding: 6px 14px; background: #fff; border: 1px solid #d0d0d0; color: #777; font-size: 0.8rem; border-radius: 3px; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; font-weight: 500; letter-spacing: 1px; }
      .btn-mini-muji:active, .btn-mini-muji:hover { background: #fafafa; border-color: var(--accent-brown); color: var(--accent-brown); }
      
      #mini-gratitude-list { list-style: none; padding: 0; margin: 0 0 8px 0; display: flex; flex-direction: column; overflow: hidden; }
      #mini-gratitude-list li { font-size: 0.85rem; color: #666; padding: 4px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.5; display: flex; align-items: center; }
      #mini-gratitude-list li .date { color: var(--accent-brown); font-size: 0.75rem; margin-right: 8px; font-family: 'Noto Sans TC', sans-serif; min-width: 40px; letter-spacing: 0.5px; font-weight: 500; }

      .routine-section { border-bottom: 1px dashed #eee; padding-bottom: 15px; margin-bottom: 15px; transition: opacity 0.3s; }
      .routine-section:last-child { border-bottom: none; margin-bottom: 0; }
      .routine-header { font-size: 0.8rem; font-weight: 600; color: var(--accent-brown); margin-bottom: 10px; letter-spacing: 1px; text-transform: uppercase; }
      .disabled-zone { opacity: 0.3; pointer-events: none; filter: grayscale(100%); background-color: #f0f0f0; } 
      .goal-label { color: var(--muji-red); font-weight: bold; margin-right: 5px; }

      .calendar-list, .journal-list { list-style: none; padding: 0; margin: 0; flex: 1; }
      .calendar-list li { padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; width: 100%; overflow: hidden; }
      .cal-date { margin-right: 5px; font-weight: 600; color: var(--accent-brown); flex-shrink: 0; }
      .cal-title-wrapper { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; color: #555; }
      
      .table-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid #ddd; border-radius: 4px; }
      .table-wrapper.scrollable { max-height: 300px; } .table-wrapper.auto-height { max-height: none; overflow-y: visible; height: 100%; }
      .muji-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; white-space: nowrap; }
      .muji-table td, .muji-table th { padding: 10px 12px; border: 1px solid #eee; color: var(--text-main); text-align: left; vertical-align: middle; }
      .muji-table th { color: #888; font-weight: normal; position: sticky; top: 0; background: #fff; z-index: 10; border-bottom: 2px solid #ccc; }
      #table-invest-calc tr:first-child th { background-color: var(--table-header-bg); color: var(--accent-brown); font-family: 'Noto Serif TC', serif; font-weight: 600; }
      #table-invest-calc td:first-child, #table-invest-calc th:first-child { position: sticky; left: 0; background: #fafafa; z-index: 20; border-right: 2px solid #eee; width: 80px; min-width: 80px; text-align: center; }
      #table-invest-calc th:first-child { z-index: 30; background: var(--table-header-bg); }
      #table-profit { table-layout: fixed; width: 100%; }
      #table-profit tr:nth-child(1) td, #table-profit tr:nth-child(2) td { background-color: var(--table-header-bg); color: var(--accent-brown); font-weight: 600; text-align: center; }
      #table-profit td:first-child { background-color: #fafafa; font-weight: 600; color: var(--accent-brown); border-right: 2px solid #eee; position: sticky; left: 0; z-index: 20; width: 85px; min-width: 85px; max-width: 85px; text-align: left; white-space: normal; }
      #table-profit td:not(:first-child) { text-align: center; width: auto; padding: 5px 2px; }
      .text-right { text-align: right; font-family: monospace; letter-spacing: 0.5px; }
      .text-pos { color: var(--muji-red) !important; font-weight: bold; } .text-neg { color: var(--muji-green) !important; font-weight: bold; } 
      .journal-list li { padding: 12px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem; line-height: 1.6; color: var(--text-main); }
      .journal-list li:last-child { border-bottom: none; }
      .journal-meta { font-size: 0.85rem; color: var(--accent-brown); font-weight: 600; font-family: 'Noto Serif TC', serif; margin-right: 5px; display: inline; }

      .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
      .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
      .modal-content { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
      .modal-header h3 { margin: 0; font-family: 'Noto Serif TC', serif; font-weight: 600; color: #333; }
      .close-btn { cursor: pointer; color: #999; font-size: 24px; }
      input[type="text"], input[type="number"], input[type="date"], select, textarea { width: 100%; padding: 12px; font-size: 0.95rem; color: #333; border: 1px solid #ddd; border-radius: 3px; background-color: #fafafa; outline: none; box-sizing: border-box; transition: border-color 0.2s; }
      input:focus, textarea:focus, select:focus { border-color: #999; background: #fff; }
      .input-group { margin-bottom: 15px; }
      label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 4px; }
      .flex-row { display: flex; gap: 8px; } .flex-col { flex: 1; }
      .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
      .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .slider { background-color: #555; }
      input:checked + .slider:before { transform: translateX(18px); }
      .chip-group { display: flex; gap: 8px; flex-wrap: wrap; }
      .muji-chip input { display: none; }
      .muji-chip span { display: inline-block; padding: 6px 12px; border: 1px solid var(--border-color); color: var(--text-sub); font-size: 0.85rem; cursor: pointer; }
      .muji-chip input:checked + span { background: var(--text-main); color: white; border-color: var(--text-main); }
      .btn-muji { width: 100%; padding: 15px; background: #333; color: white; border: none; font-size: 1rem; cursor: pointer; margin-top: 15px; border-radius: 3px; letter-spacing: 1px; transition: background 0.2s; }
      .btn-muji:active { background-color: #000; }
      .btn-muji:disabled { background-color: #ccc; }
      
      .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid var(--border-color); display: grid; grid-template-columns: 1fr 1fr 1fr; height: 56px; align-items: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
      .nav-btn { background: none; border: none; color: #bbb; height: 100%; padding: 0; cursor: pointer; display: flex; justify-content: center; align-items: center; }
      .nav-btn.active { color: #333; }
      .nav-btn .material-icons-round { font-size: 28px; }
      
      .tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.3s; }
      .mode-select-container { display: flex; flex-direction: column; gap: 10px; padding: 20px; justify-content: center; height: 50vh; }
      .mode-btn { padding: 15px; font-size: 1rem; border: 1px solid #ddd; background: #fff; border-radius: 4px; color: #555; text-align: center; cursor: pointer; display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 10px; }
      .mode-btn:active { background: #f0f0f0; }
      .operation-container { padding-bottom: 70px; max-width: 600px; margin: 0 auto; }
      .hidden { display: none !important; }
      .mini-select { font-size: 0.85rem; padding: 5px; height: 32px; }
      .tech-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
      .tech-item label { font-size: 0.75rem; margin-bottom: 2px; display: block; }
      .journal-section-btn { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 15px; margin-top: 15px; background: #fff; border: 1px solid #ddd; border-radius: 4px; text-align: left; color: #555; font-size: 1rem; cursor: pointer; }
      .journal-section-btn:active { background: #f9f9f9; }
      .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px dashed #eee; }
      #toast { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); background: var(--text-main); color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 3000; white-space: nowrap; }
      @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
    </style>
</head>
<body>
    <header>
      <div class="date-weather-box">
        <div class="current-date"><span id="header-date">...</span> <span id="header-day" class="day-tag">...</span></div>
        <div class="weather-info" id="weather-display"><span class="material-icons-round">wb_sunny</span> <span>讀取中...</span></div>
      </div>
    </header>
    <main id="app">
      <div id="tab-dashboard" class="tab-content active">
          <div class="dashboard-grid">
            <div class="muji-card schedule-card">
                <div class="card-label">SCHEDULE</div>
                <ul class="calendar-list" id="calendar-list-display">
                    <li><span class="cal-date">--:--</span><span class="cal-title-wrapper">載入中...</span></li>
                </ul>
            </div>
            <div class="right-col">
                <div class="muji-card goal-card">
                    <div class="goal-header-group">
                        <div class="card-label" style="margin:0;">目標實踐</div>
                        <div class="cycle-badge" id="goal-cycle-badge">第 01 期</div>
                    </div>

                    <div class="macro-goal-container">
                        <div class="macro-row">
                            <span class="macro-label">年</span>
                            <span class="macro-text" id="goal-year-text">2026 全方位自我優化</span>
                        </div>
                        <div class="macro-row">
                            <span class="macro-label season">季</span>
                            <span class="macro-text" id="goal-season-text">Q1 節目改版 / 資產重整</span>
                        </div>
                    </div>

                    <div class="cycle-list-container" id="goal-cycle-list">
                        <div class="cycle-list-item">
                            <span class="cycle-cat">工作</span>
                            <span class="cycle-desc">英語提案翻譯</span>
                        </div>
                        <div class="cycle-list-item">
                            <span class="cycle-cat">生活</span>
                            <span class="cycle-desc">Pixel 10 測試</span>
                        </div>
                        <div class="cycle-list-item">
                            <span class="cycle-cat">習慣</span>
                            <span class="cycle-desc">Air Shot 紀錄</span>
                        </div>
                    </div>
                </div>

                <div class="muji-card quote-card">
                    <div class="card-label">QUOTE</div>
                    <div class="quote-text">"Less is more."</div>
                </div>
            </div>
          </div>
          
          <div class="dashboard-main-grid">
               </div>
      </div>

      <div id="tab-operation" class="tab-content">
        <div class="muji-title">操作紀錄</div>
        <div id="op-selection" class="mode-select-container">
          <div class="mode-btn" onclick="selectMode('swing')"><span class="material-icons-round">trending_up</span> 波段操作</div>
          <div class="mode-btn" onclick="selectMode('daytrade')"><span class="material-icons-round">flash_on</span> 當沖交易</div>
        </div>
        
        <div id="form-swing" class="operation-container hidden">
          <div class="muji-card">
            <div style="display:flex; align-items:center; margin-bottom:15px; color:#888; font-size:0.9rem; cursor:pointer;" onclick="backToSelection()">
               <span class="material-icons-round" style="font-size:18px; margin-right:4px;">arrow_back</span> 返回
            </div>
            <form id="stockForm">
              <div class="input-group"><label>日期</label><input type="date" id="s_date" required></div>
              <div class="flex-row"><div class="flex-col input-group"><label>代號</label><input type="text" id="s_code" placeholder="2330" required inputmode="num
