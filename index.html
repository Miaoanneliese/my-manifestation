// === 系統設定 ===
var SPREADSHEET_ID = '1vRIp7aP_Fz8fCClQ8PzQs-412KsM_uvyY3WsEqUedxg'; // 記帳/投資表
var GOAL_SPREADSHEET_ID = '14ezIQwSe6rpl7iPVYL80RKpAB_N-xqaZ-oiXZHqn_nY'; // 目標/紀錄表
var FIREBASE_URL = "https://manifestation-fc95b-default-rtdb.asia-southeast1.firebasedatabase.app/";
var FIREBASE_SECRET = "k6qAKfvcw2eqPcluPZO5JUyIcwLp6j31AM8jYNWo"; 

// 行事曆設定
var CALENDARS_CONFIG = [
  { id: '2ioc27hhmbm38q2rkmbitk9ro4@group.calendar.google.com', color: '#6c8c6e' }, // 綠
  { id: '1f8v85pbk1d911eki8osttjvdk@group.calendar.google.com', color: '#d6c68b' }, // 黃
  { id: 'stopannelies@gmail.com', color: '#d99598' } // 桃紅
];

// === 支援前端抓取 ===
function doGet(e) {
  if (!e || !e.parameter || !e.parameter.action) {
    return HtmlService.createTemplateFromFile('index')
      .evaluate()
      .setTitle('我的生活・投資手帖')
      .addMetaTag('viewport', 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no');
  }
  
  if (e.parameter.action === "getMission") {
      var ss = SpreadsheetApp.openById(GOAL_SPREADSHEET_ID);
      var result = { 
       year_goal: "未設定", season_goal: "未設定", 
       cycle_id: "?", cycle_goal: "未設定", cycle_range: "",
       career: "-", health: "-", wealth: "-", skills: "-", life: "-", 
       habit_names: ["習慣 1", "習慣 2", "習慣 3", "習慣 4"],
       completion_rate: "0%",
       questions: [] 
      };

      // 1. 抓取當期目標 & 計算習慣達成率
      var tSheet = ss.getSheetByName('Plan_Targets');
      if (tSheet && tSheet.getLastRow() > 1) {
        var tData = tSheet.getDataRange().getValues();
        var checkDate = new Date();
        checkDate.setHours(0,0,0,0);
        
        for (var i = 1; i < tData.length; i++) {
          var type = tData[i][0];
          var startDate = new Date(tData[i][2]);
          var endDate = new Date(tData[i][3]);
          startDate.setHours(0,0,0,0);
          endDate.setHours(0,0,0,0);
          
          if (checkDate >= startDate && checkDate <= endDate) {
            if (type === 'Year') result.year_goal = tData[i][4];
            else if (type === 'Season') result.season_goal = tData[i][4];
            else if (type === 'Cycle') {
              result.cycle_id = tData[i][1];
              result.cycle_goal = tData[i][4];
              var sStr = (startDate.getMonth()+1) + "/" + startDate.getDate();
              var eStr = (endDate.getMonth()+1) + "/" + endDate.getDate();
              result.cycle_range = sStr + " - " + eStr;
              result.career = tData[i][5]; result.health = tData[i][6];
              result.wealth = tData[i][7]; result.skills = tData[i][8];
              result.life = tData[i][9];
              
              // A. 讀取習慣名稱 (K, L, M, N 欄 -> Index 10, 11, 12, 13)
              result.habit_names = [
                  tData[i][10] || "習慣 1",
                  tData[i][11] || "習慣 2",
                  tData[i][12] || "習慣 3",
                  tData[i][13] || "習慣 4"
              ];

              // B. 計算達成率邏輯
              try {
                  var rSheet = ss.getSheetByName('紀錄');
                  if (rSheet && rSheet.getLastRow() > 1) {
                      var rData = rSheet.getDataRange().getValues();
                      var trueCount = 0;
                      // 計算經過天數 (startDate 到 today)
                      var diffTime = checkDate.getTime() - startDate.getTime();
                      var elapsedDays = Math.floor(diffTime / (1000 * 3600 * 24)) + 1;
                      if (elapsedDays < 1) elapsedDays = 1;

                      // 遍歷紀錄表 (假設第1列是標題)
                      for (var r = 1; r < rData.length; r++) {
                          var rowDate = rData[r][1]; // B欄 日期
                          if (rowDate instanceof Date) {
                              rowDate.setHours(0,0,0,0);
                              if (rowDate >= startDate && rowDate <= checkDate) {
                                  // 檢查 AM(38), AN(39), AO(40), AP(41)
                                  // Google Sheet 的 TRUE 可能是布林值 true 或字串 "TRUE"
                                  if (rData[r][38] === true || rData[r][38] === "TRUE") trueCount++;
                                  if (rData[r][39] === true || rData[r][39] === "TRUE") trueCount++;
                                  if (rData[r][40] === true || rData[r][40] === "TRUE") trueCount++;
                                  if (rData[r][41] === true || rData[r][41] === "TRUE") trueCount++;
                              }
                          }
                      }
                      
                      var totalPossible = elapsedDays * 4;
                      var rate = (totalPossible > 0) ? (trueCount / totalPossible) : 0;
                      result.completion_rate = Math.round(rate * 100) + "%";
                  }
              } catch(e) {
                  console.error("計算達成率錯誤: " + e.toString());
                  result.completion_rate = "Err";
              }
            }
          }
        }
      }

      // 2. 抓取每日題庫
      var qSheet = ss.getSheetByName('Daily_Questions');
      if (qSheet && qSheet.getLastRow() > 1) {
        var qData = qSheet.getRange(2, 1, qSheet.getLastRow() - 1, 4).getValues(); 
        result.questions = qData.map(function(row) {
            return { id: row[0], label: row[1], placeholder: row[2], options: row[3] ? row[3].toString().split(',') : [] };
        });
      }
      
      return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
  }
}

function include(filename) {
  try { return HtmlService.createHtmlOutputFromFile(filename).getContent(); }
  catch(e) { return ""; }
}

// === 核心同步功能 ===
function syncDashboardToFirebase() {
  var data = getDashboardData();
  if (data) {
    firebasePatch("dashboard", data); 
    updateUpdateSignal(); 
  }
}

function updateUpdateSignal() {
  firebasePut("system/lastUpdate", new Date().getTime());
}

function updateDailyCalendar() {
  try {
    var events = getCalendarEvents(); 
    firebasePut("dashboard/calendarEvents", events); 
    updateUpdateSignal();
    console.log("日曆已獨立更新");
  } catch(e) { console.error("日曆更新失敗: " + e.message); }
}

function setupTrigger() {
  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) ScriptApp.deleteTrigger(triggers[i]);
  ScriptApp.newTrigger('processQueue').timeBased().everyMinutes(1).create();
  syncDashboardToFirebase();
}

function processQueue() {
  var queueData = firebaseGet("request_queue");
  if (!queueData) return;

  var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  var goalSs = SpreadsheetApp.openById(GOAL_SPREADSHEET_ID);
  var hasProcessed = false;
  
  for (var key in queueData) {
      try {
        var item = queueData[key];
        var timeStr = item.timestamp ? item.timestamp.replace('T', ' ').substring(0, 19) : Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyy/MM/dd HH:mm:ss");

        if (item.type === 'expense') {
          var sheet = ss.getSheetByName('聚寶盆') || ss.insertSheet('聚寶盆');
          sheet.appendRow([timeStr, "記帳", parseFloat(item.amount)||0, item.paymentMethod, item.isSplit, item.isTobacco, item.splitMethod, item.panAmount, item.othersAmount, item.chuanPay, item.note]);
        } 
        else if (item.type === 'daytrade') {
          var sheet = ss.getSheetByName('聚寶盆') || ss.insertSheet('聚寶盆');
          var rowData = new Array(49).fill(""); 
          rowData[0] = timeStr; rowData[1] = "當沖"; rowData[31] = item.date.replace(/-/g, '/');
          rowData[32] = item.code; rowData[33] = item.name; rowData[34] = item.trend; 
          rowData[43] = item.shares; rowData[44] = item.entryPrice; rowData[46] = item.exitPrice; rowData[48] = item.exitReason;
          sheet.appendRow(rowData);
        } 
        else if (item.type === 'stock') {
          var sheet = ss.getSheetByName('聚寶盆') || ss.insertSheet('聚寶盆');
          var rowData = new Array(31).fill(""); 
          rowData[0] = timeStr; rowData[1] = "波段操作"; rowData[11] = item.date.replace(/-/g, '/');
          rowData[12] = item.code; rowData[13] = item.name; rowData[14] = item.shares; rowData[15] = item.price;
          rowData[18] = item.action;
          if (item.action === "進場") rowData[19] = item.reason; else rowData[20] = item.reason;
          sheet.appendRow(rowData);
        }
        else if (item.type === 'daily_routine') {
           handleJournalEntry(goalSs, item);
        }
        else if (item.type === 'journal') {
           handleJournalEntry(goalSs, item);
        }
        else if (item.type === 'plan_update') { 
           var sheet = goalSs.getSheetByName('Plan2026');
           if (sheet) {
             var data = sheet.getDataRange().getValues();
             for (var r = 1; r < data.length; r++) {
               if (data[r][0] == item.id) { sheet.getRange(r + 1, 4).setValue(item.status ? "TRUE" : ""); break; }
             }
           }
        } 
        else if (item.type === 'goal') handleJournalEntry(goalSs, {journalType: 'goal_legacy', text: item.text});
        
        firebaseDelete("request_queue/" + key);
        hasProcessed = true;
      } catch (e) { console.error("處理失敗 ID:" + key + " Error:" + e.message); }
  }

  if (hasProcessed) {
      SpreadsheetApp.flush(); 
      Utilities.sleep(1000); 
      syncDashboardToFirebase(); 
  }
}

// === 核心寫入邏輯 ===
function handleJournalEntry(ss, data) {
  var sheet = ss.getSheetByName('紀錄') || ss.insertSheet('紀錄');
  var dateStr = data.date ? data.date.replace(/-/g, '/') : Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyy/MM/dd");
  
  var lastRow = sheet.getLastRow();
  var targetRow = lastRow + 1;
  if (lastRow > 1) {
    var startCheck = Math.max(2, lastRow - 10);
    var dateData = sheet.getRange(startCheck, 2, lastRow - startCheck + 1, 1).getValues();
    for (var i = 0; i < dateData.length; i++) {
       var d = dateData[i][0];
       var dStr = (d instanceof Date) ? Utilities.formatDate(d, Session.getScriptTimeZone(), "yyyy/MM/dd") : d;
       if (dStr === dateStr) { targetRow = startCheck + i; break; }
    }
  }

  var totalCols = 42; // 到 AP 欄
  var currentData = [];
  if (targetRow <= lastRow) {
      var fetched = sheet.getRange(targetRow, 1, 1, totalCols).getValues()[0];
      currentData = fetched;
      if (currentData.length < totalCols) {
          for(var k=currentData.length; k<totalCols; k++) currentData.push("");
      }
  } else {
      currentData = new Array(totalCols).fill("");
      currentData[0] = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyy/MM/dd HH:mm:ss");
      currentData[1] = dateStr;
  }

  // 資料映射
  if (data.q3) currentData[2] = data.q3;
  if (data.q4) currentData[3] = data.q4;
  if (data.q5) currentData[4] = data.q5;
  if (data.q6) currentData[5] = data.q6;
  if (data.q7) currentData[6] = data.q7;
  if (data.q8) currentData[7] = data.q8;
  if (data.q9) currentData[8] = data.q9;
  if (data.q10) currentData[9] = data.q10;
  if (data.q11) currentData[10] = data.q11;
  if (data.q12) currentData[11] = data.q12 + (data.q12.toString().indexOf('%') > -1 ? '' : '%');

  if (data.q89) currentData[15] = data.q89;
  if (data.q91) currentData[17] = data.q91;
  if (data.q93) currentData[18] = data.q93;
  if (data.q94) currentData[19] = data.q94;
  if (data.q95) currentData[20] = data.q95;
  if (data.q96) currentData[21] = data.q96;
  if (data.q97) currentData[22] = data.q97;
  if (data.q98) currentData[23] = data.q98;
  if (data.q99) currentData[24] = data.q99;
  if (data.content) currentData[25] = data.content;

  if (data.score) currentData[26] = data.score;
  if (data.is_recording) currentData[27] = data.is_recording;
  if (data.wealth_evidence) currentData[28] = data.wealth_evidence;
  if (data.invest_practice) currentData[29] = data.invest_practice;

  if (data.career_review) {
      var parts = data.career_review.split('|');
      parts.forEach(function(p) {
         p = p.trim();
         if (p.indexOf('【人】') === 0) currentData[30] = p.replace('【人】', '').trim();
         if (p.indexOf('【事】') === 0) currentData[31] = p.replace('【事】', '').trim();
         if (p.indexOf('【焦點】') > -1 || p.indexOf('【進度】') > -1) currentData[32] = p.replace(/【.*】/, '').trim();
      });
  }

  if (data.health_status) {
      currentData[33] = data.health_status;
      var hParts = data.health_status.split('|');
      hParts.forEach(function(p) {
         p = p.trim();
         if (p.indexOf('運動:') === 0) currentData[34] = p.replace('運動:', '').trim();
         if (p.indexOf('保養:') === 0) currentData[35] = p.replace('保養:', '').trim();
      });
  }

  if (data.declutter_item) {
     var itemStr = data.declutter_item;
     var match = itemStr.match(/(.*)\s\((.*)\)/);
     if (match) {
        currentData[36] = match[1].trim();
        currentData[37] = match[2].trim();
     } else {
        currentData[36] = itemStr;
     }
  }

  // 習慣 Check -> AM(38), AN(39), AO(40), AP(41)
  // 如果是錄影日，清空；否則寫入
  if (data.is_recording === "是") {
      currentData[38] = ""; currentData[39] = ""; currentData[40] = ""; currentData[41] = "";
  } else {
      if (data.q86 !== undefined) currentData[38] = data.q86;
      if (data.q87 !== undefined) currentData[39] = data.q87;
      if (data.q88 !== undefined) currentData[40] = data.q88;
      if (data.q90 !== undefined) currentData[41] = data.q90;
  }

  if (data.note) {
     var nParts = data.note.split('|');
     if (!currentData[15] && nParts[0]) currentData[15] = nParts[0].trim();
     if (!currentData[17] && nParts[1]) currentData[17] = nParts[1].replace('感受:', '').trim();
  }

  if (targetRow > lastRow) {
      sheet.appendRow(currentData);
  } else {
      sheet.getRange(targetRow, 1, 1, currentData.length).setValues([currentData]);
  }
}

// ... 以下 getDashboardData, getCalendarEvents, doPost 等函式保持不變 ...
function getDashboardData() {
  var result = { 
    todayExpense: 0, monthExpense: 0, quote: getDailyQuote(), goalText: "", 
    investCalcData: [], profitData: [], 
    gratitudeList: [], manifestationList: [], 
    widget: { profitSum: 0, profitPercent: "0%", goal: "無目標" }
  };
  try {
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var goalSs = SpreadsheetApp.openById(GOAL_SPREADSHEET_ID);
    var today = new Date();
    var todayStr = Utilities.formatDate(today, Session.getScriptTimeZone(), "yyyy/MM/dd");
    var yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
    var yesterdayStr = Utilities.formatDate(yesterday, Session.getScriptTimeZone(), "yyyy/MM/dd");

    // 1. Expense
    var sheet = ss.getSheetByName('聚寶盆');
    if (sheet && sheet.getLastRow() > 1) {
      var startRow = Math.max(1, sheet.getLastRow() - 500); 
      var data = sheet.getRange(startRow, 1, sheet.getLastRow()-startRow+1, 3).getValues(); 
      var daySum = 0; 
      for (var i = 0; i < data.length; i++) {
        if (data[i][1] === '記帳') {
           var rDate = data[i][0];
           var rDateStr = (rDate instanceof Date) ? Utilities.formatDate(rDate, Session.getScriptTimeZone(), "yyyy/MM/dd") : (typeof rDate === 'string' && rDate.indexOf(todayStr) > -1 ? todayStr : "");
           if (rDateStr === todayStr) daySum += parseAmount(data[i][2]);
        }
      }
      result.todayExpense = daySum;
    }
    // 2. Month Expense
    var statsSheet = ss.getSheetByName('消費統計');
    if (statsSheet && statsSheet.getLastRow() > 0) {
        var lastRow = statsSheet.getLastRow();
        var startRead = Math.max(1, lastRow - 24); 
        var targetDate = new Date(today);
        if (targetDate.getDate() < 5) targetDate.setMonth(targetDate.getMonth() - 1);
        targetDate.setDate(5);
        var targetDateStr = Utilities.formatDate(targetDate, Session.getScriptTimeZone(), "yyyy/M/d");
        var statsData = statsSheet.getRange(startRead, 1, lastRow - startRead + 1, 23).getValues(); 
        for (var i = 0; i < statsData.length; i++) {
            var dStr = (statsData[i][0] instanceof Date) ? Utilities.formatDate(statsData[i][0], Session.getScriptTimeZone(), "yyyy/M/d") : statsData[i][0];
            if (dStr === targetDateStr) { result.monthExpense = parseAmount(statsData[i][22]); break; }
        }
    }
    // 3. Journal
    var recordSheet = goalSs.getSheetByName('紀錄');
    if (recordSheet && recordSheet.getLastRow() > 1) {
        var lastRow = recordSheet.getLastRow();
        var startRead = Math.max(1, lastRow - 50); 
        var recordData = recordSheet.getRange(startRead, 1, lastRow - startRead + 1, 26).getValues(); 
        var todayGoalC = "", yesterdayPlanY = ""; 
        for (var i = recordData.length - 1; i >= 0; i--) {
            var row = recordData[i];
            var dateVal = row[1]; 
            var dateStr = (dateVal instanceof Date) ? Utilities.formatDate(dateVal, Session.getScriptTimeZone(), "yyyy/MM/dd") : dateVal;
            if (dateStr === todayStr && row[2] && todayGoalC === "") todayGoalC = row[2];
            if (dateStr === yesterdayStr && row[24] && yesterdayPlanY === "") yesterdayPlanY = row[24];
            if (row[25] && result.gratitudeList.length < 5) result.gratitudeList.push({ date: dateStr, content: row[25] });
            if (row[18] && result.manifestationList.length < 3) { 
                 var s1 = "style='color:#999;'", s2 = "style='color:#333;'";
                 var content = `<span ${s1}>感謝一切,我在</span> <span ${s2}>${row[18]}</span> <span ${s1}>之前</span> <span ${s2}>${row[19]}</span>`;
                 if(row[20]) content += ` <span ${s1}>我感覺</span> <span ${s2}>${row[20]}</span>`;
                 result.manifestationList.push({ date: dateStr, content: content }); 
            }
        }
        result.goalText = (yesterdayPlanY && todayGoalC) ? yesterdayPlanY + " ｜ " + todayGoalC : (yesterdayPlanY || todayGoalC || "");
        result.widget.goal = result.goalText || "今日未設定目標";
    }
    // 4. Invest
    var investSheet = ss.getSheetByName('投資計算') || ss.getSheetByName('投資計算表');
    if (investSheet) {
      var lastRow = investSheet.getLastRow();
      if (lastRow > 0) {
        var widgetData = investSheet.getRange(lastRow, 1, 1, 10).getValues()[0];
        result.widget.profitSum = parseAmount(widgetData[7]); 
        result.widget.profitPercent = (typeof widgetData[6] === 'number') ? (widgetData[6]*100).toFixed(2) + '%' : widgetData[6];
        var startRead = Math.max(2, lastRow - 60);
        var rawData = investSheet.getRange(startRead, 1, lastRow - startRead + 1, 10).getValues();
        var header = investSheet.getRange(1, 1, 1, 10).getValues()[0].map(String);
        result.investCalcData.push(header);
        var targetKeys = []; [-1, 0, 1].forEach(offset => { var d = new Date(today.getFullYear(), today.getMonth() + offset, 1); targetKeys.push(d.getFullYear() + "-" + d.getMonth()); });
        for (var i = 0; i < rawData.length; i++) {
          var cellDate = (rawData[i][0] instanceof Date) ? rawData[i][0] : new Date(Date.parse(rawData[i][0]));
          if (cellDate && !isNaN(cellDate)) {
             if (targetKeys.includes(cellDate.getFullYear() + "-" + cellDate.getMonth())) result.investCalcData.push(formatInvestRow(rawData[i])); 
          }
        }
      }
    }
    // 5. Profit
    var profitSheet = ss.getSheetByName('損益試算') || ss.getSheetByName('損益試算表');
    if (profitSheet) {
      var displayValues = profitSheet.getRange("A27:I38").getDisplayValues(); 
      var rawValues = profitSheet.getRange("A27:I38").getValues(); 
      if (rawValues.length > 2) {
        var checkRow = rawValues[2]; 
        var finalData = displayValues.map(r => [r[0]]);
        for (var c = 1; c < checkRow.length; c++) { if (checkRow[c] !== "" && checkRow[c] != null) { displayValues.forEach((row, rIdx) => finalData[rIdx].push(row[c])); } }
        result.profitData = finalData;
      }
    }
    return result;
  } catch (e) { console.error("讀取錯誤: " + e.message); return result; }
}

function getCalendarEvents() {
  var allEvents = [];
  var now = new Date();
  var endDate = new Date(); endDate.setDate(now.getDate() + 7);
  var weekDays = ['日', '一', '二', '三', '四', '五', '六'];
  CALENDARS_CONFIG.forEach(function(config) {
    try {
      var cal = CalendarApp.getCalendarById(config.id);
      if (cal) {
        cal.getEvents(now, endDate).forEach(function(evt) {
           var start = evt.getStartTime();
           var dateDisplay = (start.getMonth() + 1) + "/" + start.getDate() + " (" + weekDays[start.getDay()] + ")";
           var titleDisplay = evt.getTitle();
           var isRecord = titleDisplay.indexOf('錄影') > -1; 
           if (!evt.isAllDayEvent()) titleDisplay = "[" + Utilities.formatDate(start, Session.getScriptTimeZone(), "HH:mm") + "] " + titleDisplay;
           allEvents.push({ timestamp: start.getTime(), date: dateDisplay, title: titleDisplay, color: isRecord ? '#d35400' : config.color });
        });
      }
    } catch (e) { console.error("日曆讀取失敗: " + config.id); }
  });
  return allEvents.sort(function(a, b) { return a.timestamp - b.timestamp; });
}

function formatInvestRow(row) {
    return row.map(function(item, idx) {
         if (idx === 0 && item instanceof Date) return Utilities.formatDate(item, Session.getScriptTimeZone(), "yyyy/M");
         if (item instanceof Date) return Utilities.formatDate(item, Session.getScriptTimeZone(), "yyyy/M/d");
         if (typeof item === 'number') { if (idx === 6) return (item * 100).toFixed(2) + '%'; return Math.round(item).toString(); }
         return item === "" ? "" : item.toString();
    });
}

function parseAmount(val) {
  if (!val) return 0;
  if (typeof val === 'number') return val;
  return parseFloat(val.toString().replace(/,/g, '')) || 0;
}

function getDailyQuote() {
  var quotes = ["簡單生活不是少，而是剛剛好。", "花若盛開，蝴蝶自來。", "接受當下，就是最好的顯化。", "富有不是擁有多，而是要求少。", "今天的累積，是明天的奇蹟。"];
  return quotes[Math.floor(Date.now() / 86400000) % quotes.length];
}

function doPost(e) {
  if (e && e.postData) {
      try {
          var data = JSON.parse(e.postData.contents);
          var ss = SpreadsheetApp.openById(GOAL_SPREADSHEET_ID);
          handleJournalEntry(ss, data);
          return ContentService.createTextOutput(JSON.stringify({result: "success"})).setMimeType(ContentService.MimeType.JSON);
      } catch(err) {
          return ContentService.createTextOutput(JSON.stringify({result: "error", message: err.message})).setMimeType(ContentService.MimeType.JSON);
      }
  }
  return ContentService.createTextOutput(JSON.stringify({result: "Use Firebase Queue for other writes"})).setMimeType(ContentService.MimeType.JSON);
}

function firebasePut(path, data) { UrlFetchApp.fetch(FIREBASE_URL + path + ".json?auth=" + FIREBASE_SECRET, { method: "PUT", payload: JSON.stringify(data), muteHttpExceptions: true }); }
function firebaseGet(path) { var res = UrlFetchApp.fetch(FIREBASE_URL + path + ".json?auth=" + FIREBASE_SECRET, { muteHttpExceptions: true }); return (res.getResponseCode() === 200) ? JSON.parse(res.getContentText()) : null; }
function firebaseDelete(path) { UrlFetchApp.fetch(FIREBASE_URL + path + ".json?auth=" + FIREBASE_SECRET, { method: "DELETE", muteHttpExceptions: true }); }
function firebasePatch(path, data) { UrlFetchApp.fetch(FIREBASE_URL + path + ".json?auth=" + FIREBASE_SECRET, { method: "PATCH", payload: JSON.stringify(data), muteHttpExceptions: true }); }

function handleManualSync(e) {
  var range = e.range;
  var sheet = range.getSheet();
  if (sheet.getName() === "損益試算" && range.getA1Notation() === "A27") {
    var isChecked = range.getValue();
    if (isChecked === true) {
      syncDashboardToFirebase(); 
      range.setValue(false);     
    }
  }
}
