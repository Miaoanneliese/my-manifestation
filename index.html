<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„ç”Ÿæ´»ãƒ»æŠ•è³‡æ‰‹å¸–</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&family=Noto+Sans+TC:wght@300;400;500&family=Material+Icons+Round&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
      /* --- Muji é¢¨æ ¼è‰²ç³» --- */
      :root { 
          --bg-color: #F9F9F6; 
          --card-bg: #FFFFFF; 
          --text-main: #4a4a4a; 
          --text-sub: #999999; 
          --border-color: #EBEBEB;    
          --muji-red: #8a1c1c; 
          --muji-green: #6c8c6e; 
          --accent-brown: #8D8170; 
          --tag-bg: #E6E4E0;
          --btn-green: #597e5d; 
          --table-header-bg: #f4f4f0; 
      }
      
      * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
      body { margin: 0; font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: var(--text-main); padding-bottom: 80px; letter-spacing: 0.03em; }
      header { background-color: var(--bg-color); padding: 25px 20px 10px; }
      
      .date-weather-box { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid var(--text-main); padding-bottom: 10px; }
      .current-date { font-family: 'Noto Serif TC', serif; font-size: 1.5rem; font-weight: 900; color: #333; }
      .day-tag { font-size: 0.9rem; margin-left: 5px; color: var(--text-sub); }
      .weather-info { display: flex; align-items: center; font-size: 0.9rem; color: var(--text-sub); gap: 5px; }
      
      main { padding: 20px; }
      
      .muji-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 3px; padding: 15px 20px; margin-bottom: 15px; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.02); display: flex; flex-direction: column; }
      .card-label { font-size: 0.7rem; color: var(--text-sub); margin-bottom: 10px; letter-spacing: 1.5px; font-weight: 500; text-transform: uppercase; }
      .muji-title { font-family: 'Noto Serif TC', serif; font-size: 1.4rem; margin: 10px 0 20px; text-align: center; color: var(--muji-red); }
      .big-number { font-size: 1.6rem; font-weight: 300; font-family: 'Noto Serif TC', serif; color: #333; }
      
      .dashboard-grid { display: flex; gap: 10px; margin-bottom: 15px; align-items: stretch; }
      .schedule-card { flex: 3; margin-bottom: 0; }
      .right-col { flex: 2; display: flex; flex-direction: column; gap: 10px; }
      .goal-card, .quote-card { flex: 1; margin-bottom: 0; }
      .goal-text-read { font-family: 'Noto Serif TC', serif; color: var(--text-main); font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap; flex: 1; overflow-y: auto; scrollbar-width: thin; max-height: 100px; }
      .quote-text { font-family: 'Noto Serif TC', serif; font-size: 0.85rem; line-height: 1.6; color: var(--accent-brown); flex: 1; display: flex; align-items: center; }

      .dashboard-main-grid { display: grid; grid-template-columns: 1fr 55px 1fr 55px; gap: 10px; align-items: stretch; }
      .dashboard-main-grid > * { min-width: 0; } 
      .dashboard-main-grid .muji-card, .dashboard-main-grid .action-btn-container { margin-bottom: 0; height: 100%; }
      .grid-left-block { grid-column: 1 / 3; } .grid-right-block { grid-column: 3 / 5; } .grid-full-width { grid-column: 1 / 5; }
      .grid-c1 { grid-column: 1; } .grid-c2 { grid-column: 2; } .grid-c3 { grid-column: 3; } .grid-c4 { grid-column: 4; }
      
      .left-stack-wrapper { display: flex; flex-direction: column; gap: 10px; height: 100%; }
      .left-stack-wrapper .muji-card:last-child { flex: 1; }
      
      .goal-text-read::-webkit-scrollbar { width: 4px; } .goal-text-read::-webkit-scrollbar-thumb { background-color: #eee; border-radius: 4px; }
      .routine-wrapper { flex: 1; overflow-y: visible; min-height: 0; padding-right: 2px; display: flex; flex-direction: column; gap: 10px; }
      .routine-wrapper .muji-card { margin-bottom: 0; border: none; box-shadow: none; padding: 0; }

      .expense-display { display: flex; flex-direction: column; justify-content: center; min-width: 0; }
      .action-btn-container { width: 55px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); text-decoration: none; background: #fff; border: 1px solid var(--border-color); transition: all 0.2s; }
      .action-btn-container:active { transform: scale(0.95); background: #f5f5f5; }
      .record-btn { background: var(--muji-red); color: white; border-color: var(--muji-red); }
      .link-btn { background: var(--btn-green); color: white; border-color: var(--btn-green); }
      .btn-icon span { font-size: 26px; margin-bottom: 2px; }
      .btn-text { font-size: 0.75rem; letter-spacing: 1px; writing-mode: vertical-rl; text-orientation: upright; }
      
      .gratitude-compact { display: flex; flex-direction: row; gap: 8px; align-items: center; margin-top: auto; padding-top: 8px; border-top: 1px solid #f0f0f0; }
      .input-underline { flex: 1; border: none; border-bottom: 1px solid #ddd; background: transparent; padding: 4px 0; font-size: 0.9rem; border-radius: 0; outline: none; transition: border-color 0.3s; }
      .input-underline:focus { border-bottom-color: var(--accent-brown); }
      .btn-mini-muji { padding: 6px 14px; background: #fff; border: 1px solid #d0d0d0; color: #777; font-size: 0.8rem; border-radius: 2px; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; font-weight: 500; letter-spacing: 1px; }
      .btn-mini-muji:active, .btn-mini-muji:hover { background: #fafafa; border-color: var(--accent-brown); color: var(--accent-brown); }
      
      #mini-gratitude-list { list-style: none; padding: 0; margin: 0 0 8px 0; display: flex; flex-direction: column; overflow: hidden; }
      #mini-gratitude-list li { font-size: 0.85rem; color: #666; padding: 4px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.6; display: flex; align-items: center; }
      #mini-gratitude-list li .date { color: var(--accent-brown); font-size: 0.75rem; margin-right: 8px; font-family: 'Noto Sans TC', sans-serif; min-width: 40px; letter-spacing: 0.5px; font-weight: 500; }

      .routine-section { border-bottom: 1px dashed #eee; padding-bottom: 15px; margin-bottom: 15px; transition: opacity 0.3s; }
      .routine-section:last-child { border-bottom: none; margin-bottom: 0; }
      .routine-header { font-size: 0.8rem; font-weight: 600; color: var(--accent-brown); margin-bottom: 10px; letter-spacing: 1px; text-transform: uppercase; }
      .disabled-zone { opacity: 0.3; pointer-events: none; filter: grayscale(100%); background-color: #f0f0f0; } 
      .goal-label { color: var(--muji-red); font-weight: bold; margin-right: 5px; }

      .calendar-list, .journal-list { list-style: none; padding: 0; margin: 0; flex: 1; }
      .calendar-list li { padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; width: 100%; overflow: hidden; }
      .cal-date { margin-right: 5px; font-weight: 600; color: var(--accent-brown); flex-shrink: 0; }
      .cal-title-wrapper { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; color: #555; }
      
      .table-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid #ddd; border-radius: 4px; }
      .table-wrapper.scrollable { max-height: 300px; } .table-wrapper.auto-height { max-height: none; overflow-y: visible; height: 100%; }
      .muji-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; white-space: nowrap; }
      .muji-table td, .muji-table th { padding: 10px 12px; border: 1px solid #eee; color: var(--text-main); text-align: left; vertical-align: middle; }
      .muji-table th { color: #888; font-weight: normal; position: sticky; top: 0; background: #fff; z-index: 10; border-bottom: 2px solid #ccc; }
      #table-invest-calc tr:first-child th { background-color: var(--table-header-bg); color: var(--accent-brown); font-family: 'Noto Serif TC', serif; font-weight: 600; }
      #table-invest-calc td:first-child, #table-invest-calc th:first-child { position: sticky; left: 0; background: #fafafa; z-index: 20; border-right: 2px solid #eee; width: 80px; min-width: 80px; text-align: center; }
      #table-invest-calc th:first-child { z-index: 30; background: var(--table-header-bg); }
      #table-profit { table-layout: fixed; width: 100%; }
      #table-profit tr:nth-child(1) td, #table-profit tr:nth-child(2) td { background-color: var(--table-header-bg); color: var(--accent-brown); font-weight: 600; text-align: center; }
      #table-profit td:first-child { background-color: #fafafa; font-weight: 600; color: var(--accent-brown); border-right: 2px solid #eee; position: sticky; left: 0; z-index: 20; width: 85px; min-width: 85px; max-width: 85px; text-align: left; white-space: normal; }
      #table-profit td:not(:first-child) { text-align: center; width: auto; padding: 5px 2px; }
      .text-right { text-align: right; font-family: monospace; letter-spacing: 0.5px; }
      .text-pos { color: var(--muji-red) !important; font-weight: bold; } .text-neg { color: var(--muji-green) !important; font-weight: bold; } 
      .journal-list li { padding: 12px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem; line-height: 1.6; color: var(--text-main); }
      .journal-list li:last-child { border-bottom: none; }
      .journal-meta { font-size: 0.85rem; color: var(--accent-brown); font-weight: 600; font-family: 'Noto Serif TC', serif; margin-right: 5px; display: inline; }

      .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
      .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
      .modal-content { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
      .modal-header h3 { margin: 0; font-family: 'Noto Serif TC', serif; font-weight: 600; color: #333; }
      .close-btn { cursor: pointer; color: #999; font-size: 24px; }
      input[type="text"], input[type="number"], input[type="date"], select, textarea { width: 100%; padding: 12px; font-size: 0.95rem; color: #333; border: 1px solid #ddd; border-radius: 2px; background-color: #fafafa; outline: none; box-sizing: border-box; transition: border-color 0.2s; }
      input:focus, textarea:focus, select:focus { border-color: #999; background: #fff; }
      .input-group { margin-bottom: 15px; }
      label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 4px; }
      .flex-row { display: flex; gap: 8px; } .flex-col { flex: 1; }
      .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
      .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .slider { background-color: #555; }
      input:checked + .slider:before { transform: translateX(18px); }
      .chip-group { display: flex; gap: 8px; flex-wrap: wrap; }
      .muji-chip input { display: none; }
      .muji-chip span { display: inline-block; padding: 6px 12px; border: 1px solid var(--border-color); color: var(--text-sub); font-size: 0.85rem; cursor: pointer; border-radius: 2px; }
      .muji-chip input:checked + span { background: var(--text-main); color: white; border-color: var(--text-main); }
      .btn-muji { width: 100%; padding: 15px; background: #333; color: white; border: none; font-size: 1rem; cursor: pointer; margin-top: 15px; border-radius: 2px; letter-spacing: 1px; transition: background 0.2s; }
      .btn-muji:active { background-color: #000; }
      .btn-muji:disabled { background-color: #ccc; }
      
      .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid var(--border-color); display: grid; grid-template-columns: 1fr 1fr 1fr; height: 56px; align-items: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
      .nav-btn { background: none; border: none; color: #bbb; height: 100%; padding: 0; cursor: pointer; display: flex; justify-content: center; align-items: center; }
      .nav-btn.active { color: #444; }
      .nav-btn .material-icons-round { font-size: 28px; }
      
      .tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.3s; }
      .mode-select-container { display: flex; flex-direction: column; gap: 10px; padding: 20px; justify-content: center; height: 50vh; }
      .mode-btn { padding: 15px; font-size: 1rem; border: 1px solid #ddd; background: #fff; border-radius: 4px; color: #555; text-align: center; cursor: pointer; display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 10px; }
      .mode-btn:active { background: #f0f0f0; }
      .operation-container { padding-bottom: 70px; max-width: 600px; margin: 0 auto; }
      .hidden { display: none !important; }
      .mini-select { font-size: 0.85rem; padding: 5px; height: 32px; }
      .tech-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
      .tech-item label { font-size: 0.75rem; margin-bottom: 2px; display: block; }
      .journal-section-btn { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 15px; margin-top: 15px; background: #fff; border: 1px solid #ddd; border-radius: 4px; text-align: left; color: #555; font-size: 1rem; cursor: pointer; }
      .journal-section-btn:active { background: #f9f9f9; }
      .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px dashed #eee; }
      #toast { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); background: var(--text-main); color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 3000; white-space: nowrap; }
      @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

      .goal-header-group { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px 8px; border-bottom: 1px solid #f0f0f0; }
      .cycle-badge { background-color: var(--muji-red); color: white; font-size: 0.75rem; padding: 2px 10px; border-radius: 12px; font-weight: 500; letter-spacing: 0.5px; }
      
      .macro-goal-container { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; background-color: #fff; }
      
      .macro-row { display: flex; align-items: baseline; margin-bottom: 10px; width: 100%; }
      .macro-row:last-child { margin-bottom: 0; }
      .split-container { display: flex; width: 100%; gap: 15px; margin-bottom: 10px; }
      .split-block { flex: 1; display: flex; align-items: baseline; min-width: 0; } 
      
      .macro-label { font-size: 0.7rem; color: #555; background-color: var(--tag-bg); padding: 2px 6px; border-radius: 2px; margin-right: 8px; flex-shrink: 0; font-weight: 500; }
      .macro-text { font-size: 0.85rem; color: var(--text-main); line-height: 1.4; letter-spacing: 0.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; transition: color 0.2s; }
      .macro-text:active { color: #888; }
      .macro-text.expanded { white-space: normal; overflow: visible; word-break: break-all; }
      .date-suffix { font-size: 0.75rem; color: #aaa; margin-left: 6px; letter-spacing: 0; }

      .cycle-list-container { flex: 1; overflow-y: auto; padding: 8px 15px 12px; }
      .cycle-list-item { padding: 8px 0; border-bottom: 1px dashed #eee; display: flex; align-items: flex-start; }
      .cycle-list-item:last-child { border-bottom: none; }
      .cycle-cat { color: var(--muji-red); font-weight: 600; margin-right: 8px; white-space: nowrap; font-size: 0.8rem; margin-top: 1px; min-width: 32px; }
      .cycle-desc { color: #555; font-size: 0.85rem; line-height: 1.5; }
    </style>
</head>
<body>
    <header>
      <div class="date-weather-box">
        <div class="current-date"><span id="header-date">...</span> <span id="header-day" class="day-tag">...</span></div>
        <div class="weather-info" id="weather-display"><span class="material-icons-round">wb_sunny</span> <span>è®€å–ä¸­...</span></div>
      </div>
    </header>
    <main id="app">
      <div id="tab-operation" class="tab-content">
        <div class="muji-title">æ“ä½œç´€éŒ„</div>
        <div id="op-selection" class="mode-select-container">
          <div class="mode-btn" onclick="selectMode('swing')"><span class="material-icons-round">trending_up</span> æ³¢æ®µæ“ä½œ</div>
          <div class="mode-btn" onclick="selectMode('daytrade')"><span class="material-icons-round">flash_on</span> ç•¶æ²–äº¤æ˜“</div>
        </div>
        <div id="form-swing" class="operation-container hidden">
          <div class="muji-card">
            <div style="display:flex; align-items:center; margin-bottom:15px; color:#888; font-size:0.9rem; cursor:pointer;" onclick="backToSelection()">
               <span class="material-icons-round" style="font-size:18px; margin-right:4px;">arrow_back</span> è¿”å›
            </div>
            <form id="stockForm">
              <div class="input-group"><label>æ—¥æœŸ</label><input type="date" id="s_date" required></div>
              <div class="flex-row"><div class="flex-col input-group"><label>ä»£è™Ÿ</label><input type="text" id="s_code" placeholder="2330" required inputmode="numeric"></div><div class="flex-col input-group"><label>åç¨±</label><input type="text" id="s_name" placeholder="å°ç©é›»" required></div></div>
              <div class="flex-row"><div class="flex-col input-group"><label>è‚¡æ•¸</label><input type="number" id="s_shares" placeholder="1000" inputmode="numeric"></div><div class="flex-col input-group"><label>åƒ¹æ ¼</label><input type="number" id="s_price" step="0.01" inputmode="decimal"></div></div>
              <div class="input-group"><label>äº¤å‰²åƒ¹</label><input type="number" id="s_settlement" step="1" inputmode="decimal"></div>
              <div class="flex-row"><div class="flex-col input-group"><label>è¶¨å‹¢</label><select id="s_trend"><option value="å¤š">å¤š</option><option value="ç©º">ç©º</option></select></div><div class="flex-col input-group"><label>å‹•ä½œ</label><select id="s_action" onchange="updateReasonOptions()" style="background-color: #fffef0;"><option value="é€²å ´">é€²å ´</option><option value="å‡ºå ´">å‡ºå ´</option></select></div></div>
              <div class="input-group"><label id="reasonLabel" style="color: #d35400;">é€²å ´æ¢ä»¶</label><select id="s_reason" style="border-color: #e6b0aa;"></select></div>
              <details><summary>æŠ€è¡“åˆ†æ (é¸å¡«)</summary><div class="tech-grid"><div class="tech-item"><label>å‘¨è¶¨å‹¢</label><select id="s_weekTrend" class="mini-select"><option></option><option>å¤š</option><option>ç©º</option><option>ç›¤æ•´</option></select></div><div class="tech-item"><label>æ—¥è¶¨å‹¢</label><select id="s_dayTrend" class="mini-select"><option></option><option>å¤š</option><option>ç©º</option><option>ç›¤æ•´</option></select></div><div class="tech-item"><label>ä½ç½®</label><select id="s_position" class="mini-select"><option></option><option>èµ·æ¼²</option><option>èµ°å‹¢é«˜æª”</option><option>è¶¨å‹¢é«˜æª”</option><option>é ­éƒ¨</option><option>è¡Œé€²é–“</option><option>èµ·è·Œ</option><option>èµ°å‹¢ä½æª”</option><option>è¶¨å‹¢ä½æª”</option><option>åº•éƒ¨</option></select></div><div class="tech-item"><label>æˆäº¤é‡</label><select id="s_volume" class="mini-select"><option></option><option>åƒ¹â†‘é‡â†‘</option><option>åƒ¹â†‘é‡-</option><option>åƒ¹â†‘é‡â†“</option><option>åƒ¹â†“é‡â†‘</option><option>åƒ¹â†“é‡-</option><option>åƒ¹é‡â†“</option></select></div><div class="tech-item"><label>20T</label><select id="s_ma20t" class="mini-select"><option></option><option>â†‘20Tâ†‘</option><option>â†‘20T</option><option>-20T-</option><option>â†“20Tâ†‘</option></select></div><div class="tech-item"><label>å‡ç·š</label><select id="s_maArrangement" class="mini-select"><option></option><option>3ç·šå¤šæ’</option><option>4ç·šå¤šæ’</option><option>3ç·šç©ºæ’</option><option>4ç·šç©ºæ’</option></select></div><div class="tech-item"><label>KD</label><select id="s_kd" class="mini-select"><option></option><option>é»ƒé‡‘äº¤å‰</option><option>å¤šä¸ª</option><option>å¤š</option><option>æ­»äº¡äº¤å‰</option><option>ç©ºâ†‘</option><option>ç©ºâ†“</option></select></div><div class="tech-item"><label>MACD</label><select id="s_macd" class="mini-select"><option></option><option>ç´…â†‘</option><option>ç´…â†“</option><option>ç¶ â†‘</option><option>ç¶ â†“</option></select></div></div><div class="tech-item" style="margin-top:8px;"><label>å£“åŠ›</label><select id="s_pressure" class="mini-select"><option></option><option>æ³¢æµªå‹æ…‹çš„é«˜é»(é ­)</option><option>å¯†é›†ç›¤æ•´å€</option><option>ç›¤æ•´å€çš„ä¸Š/ä¸‹é ¸ç·š</option><option>ä¸Šå‡/ä¸‹é™åˆ‡ç·š</option><option>ç§»å‹•å¹³å‡ç·š(å‡ç·š)</option><option>è·³ç©ºç¼ºå£</option><option>å¤§é‡æˆäº¤çš„ç´…é»‘Kæ£’</option><option>å¿ƒç†é æœŸ</option></select></div><div class="tech-item" style="margin-top:8px;"><label>æ”¯æ’</label><select id="s_support" class="mini-select"><option></option><option>æ³¢æµªå‹æ…‹çš„ä½é»(åº•)</option><option>å¯†é›†ç›¤æ•´å€</option><option>ç›¤æ•´å€çš„ä¸Š/ä¸‹é ¸ç·š</option><option>ä¸Šå‡/ä¸‹é™åˆ‡ç·š</option><option>ç§»å‹•å¹³å‡ç·š(å‡ç·š)</option><option>è·³ç©ºç¼ºå£</option><option>å¤§é‡æˆäº¤çš„ç´…é»‘Kæ£’</option><option>å¿ƒç†é æœŸ</option></select></div></details>
              <button type="button" class="btn-muji" onclick="submitStock()">é€å‡ºç´€éŒ„</button>
            </form>
          </div>
        </div>
        <div id="form-daytrade" class="operation-container hidden">
          <div class="muji-card">
            <div style="display:flex; align-items:center; margin-bottom:15px; color:#888; font-size:0.9rem; cursor:pointer;" onclick="backToSelection()">
               <span class="material-icons-round" style="font-size:18px; margin-right:4px;">arrow_back</span> è¿”å›
            </div>
            <form id="dayTradeForm">
              <div class="input-group"><label>æ—¥æœŸ</label><input type="date" id="d_date" required></div>
              <div class="flex-row"><div class="flex-col input-group"><label>ä»£è™Ÿ</label><input type="text" id="d_code" placeholder="2330" required inputmode="numeric"></div><div class="flex-col input-group"><label>åç¨±</label><input type="text" id="d_name" placeholder="å°ç©é›»" required></div></div>
              <div class="input-group"><label>æ“ä½œè¶¨å‹¢</label><select id="d_trend" onchange="updateDayTradeReason()" style="background-color: #fffef0;"><option value="å¤š">å¤š</option><option value="ç©º">ç©º</option></select></div>
              <div class="input-group"><label>é–å®šåŸå› </label><select id="d_reason" style="border-color: #e6b0aa;"></select></div>
              <details open><summary>é€²å ´è§€å¯Ÿ</summary><div class="tech-grid"><div class="tech-item"><label>å‰æ—¥20T</label><select id="d_prev20t" class="mini-select"><option></option><option>â†‘20Tâ†‘</option><option>â†‘20Tâ†“</option><option>â†“20Tâ†“</option><option>â†“20Tâ†‘</option></select></div><div class="tech-item"><label>å‰æ—¥é‡</label><select id="d_prevVol" class="mini-select"><option></option><option>â†‘</option><option>â†“</option></select></div><div class="tech-item"><label>å‰æ—¥KD</label><select id="d_prevKd" class="mini-select"><option></option><option>é»ƒé‡‘äº¤å‰</option><option>å¤šâ†‘</option><option>å¤šâ†“</option><option>æ­»äº¡äº¤å‰</option><option>ç©ºâ†‘</option><option>ç©ºâ†“</option></select></div><div class="tech-item"><label>æ—¥è¶¨å‹¢</label><select id="d_dayTrend" class="mini-select"><option></option><option>å¤š</option><option>ç©º</option><option>ç›¤æ•´</option></select></div><div class="tech-item"><label>15åˆ†è¶¨å‹¢</label><select id="d_trend15m" class="mini-select"><option></option><option>å¤š</option><option>ç©º</option><option>ç›¤æ•´</option></select></div><div class="tech-item"><label>5åˆ†è¶¨å‹¢</label><select id="d_trend5m" class="mini-select"><option></option><option>å¤š</option><option>ç©º</option><option>ç›¤æ•´</option></select></div></div></details>
              <div class="input-group" style="margin-top:10px;"><label>è‚¡æ•¸</label><input type="number" id="d_shares" placeholder="1000" inputmode="numeric"></div>
              <div class="flex-row"><div class="flex-col input-group"><label>é€²å ´åƒ¹</label><input type="number" id="d_entryPrice" step="0.01" inputmode="decimal"></div><div class="flex-col input-group"><label>å¯¦éš›é€²</label><input type="number" id="d_realEntryPrice" step="0.01" inputmode="decimal"></div></div>
              <div class="flex-row"><div class="flex-col input-group"><label>å‡ºå ´åƒ¹</label><input type="number" id="d_exitPrice" step="0.01" inputmode="decimal"></div><div class="flex-col input-group"><label>å¯¦éš›å‡º</label><input type="number" id="d_realExitPrice" step="0.01" inputmode="decimal"></div></div>
              <div class="input-group"><label>å‡ºå ´åŸå› </label><select id="d_exitReason"><option>åœåˆ©</option><option>åœæ</option><option>é–è‚¡è§€å¯Ÿ</option><option>é‡å£“</option><option>é‡æ’</option></select></div>
              <button type="button" class="btn-muji" onclick="submitDayTrade()">é€å‡ºç•¶æ²–ç´€éŒ„</button>
            </form>
          </div>
        </div>
      </div>
      <div id="tab-dashboard" class="tab-content active">

        <div class="dashboard-grid">
            <div class="muji-card schedule-card">
                <div class="card-label">æœ¬é€±è¡Œç¨‹</div>
                <ul class="calendar-list" id="calendar-list"><li>è®€å–ä¸­...</li></ul>
            </div>
            <div class="right-col">
                <div class="muji-card goal-card">
                    <div class="card-label">ä»Šæ—¥ç›®æ¨™</div>
                    <div id="goal-display" class="goal-text-read">è®€å–ä¸­...</div>
                </div>
                <div class="muji-card quote-card">
                    <div class="card-label">æ¯æ—¥ä¸€å¥</div>
                    <div class="quote-text" id="daily-quote">è®€å–ä¸­...</div>
                </div>
            </div>
        </div>
        
        <div class="dashboard-main-grid">
            <div class="muji-card expense-display grid-c1" onclick="triggerManualSync()">
                <div class="card-label">ä»Šæ—¥é–‹éŠ·</div>
                <div class="big-number" id="today-expense">...</div>
            </div>
            <div class="action-btn-container record-btn grid-c2" onclick="openModal()">
                <div class="btn-icon"><span class="material-icons-round">edit_note</span></div>
                <div class="btn-text">è¨˜å¸³</div>
            </div>
            <div class="muji-card expense-display grid-c3">
                <div class="card-label">æœ¬æœˆæ”¯å‡º</div>
                <div class="big-number" id="month-expense" style="color: var(--text-main);">...</div>
            </div>
            <a href="https://docs.google.com/spreadsheets/d/1vRIp7aP_Fz8fCClQ8PzQs-412KsM_uvyY3WsEqUedxg/edit#gid=1703556943" target="_blank" class="action-btn-container link-btn grid-c4">
                <div class="btn-icon"><span class="material-icons-round">table_view</span></div>
                <div class="btn-text">è¡¨æ ¼</div>
            </a>

            <div class="left-stack-wrapper grid-left-block">
                <div class="muji-card" style="padding: 12px 15px; flex: 0 0 auto; height: auto;">
                    <div class="card-label" style="margin-bottom: 2px;">æ„Ÿæ©äº‹ä»¶</div>
                    <ul id="mini-gratitude-list"><li>è®€å–ä¸­...</li></ul>
                    <div class="gratitude-compact">
                        <input type="text" id="journal-text" class="input-underline" placeholder="éš¨æ‰‹è¨˜éŒ„...">
                        <button type="button" class="btn-mini-muji" onclick="submitGratitude()">æ„Ÿè¬</button>
                    </div>
                </div>
                
                <div class="muji-card" style="display: flex; flex-direction: column; min-height: 0; overflow: hidden; padding: 0;">
                    <div class="goal-header-group">
                         <div class="card-label" style="margin:0;">ç›®æ¨™å¯¦è¸</div>
                         <div class="cycle-badge" id="cycle-id">Cycle Loading...</div>
                    </div>
    
                    <div class="macro-goal-container">
                        <div class="split-container">
                            <div class="split-block">
                                <span class="macro-label">å¹´</span>
                                <span id="goal-year" class="macro-text" onclick="toggleText(this)">...</span>
                            </div>
                            <div class="split-block">
                                <span class="macro-label">å­£</span>
                                <span id="goal-season" class="macro-text" onclick="toggleText(this)">...</span>
                            </div>
                        </div>
                        
                        <div class="macro-row">
                            <span class="macro-label">å‘¨</span>
                            <span id="cycle-range-display" class="date-suffix"></span>
                            <span id="goal-weekly" class="macro-text" onclick="toggleText(this)" style="margin-left: 8px;">...</span>
                        </div>
                    </div>
    
                    <div class="cycle-list-container">
                        <div class="cycle-list-item"><span class="cycle-cat">è·æ¥­</span> <span id="goal-career" class="cycle-desc">...</span></div>
                        <div class="cycle-list-item"><span class="cycle-cat">å¥åº·</span> <span id="goal-health" class="cycle-desc">...</span></div>
                        <div class="cycle-list-item"><span class="cycle-cat">è²¡å‹™</span> <span id="goal-wealth" class="cycle-desc">...</span></div>
                        <div class="cycle-list-item"><span class="cycle-cat">æŠ€èƒ½</span> <span id="goal-skills" class="cycle-desc">...</span></div>
                        <div class="cycle-list-item"><span class="cycle-cat">ç”Ÿæ´»</span> <span id="goal-life" class="cycle-desc">...</span></div>
                    </div>
                </div>
            </div>
            
            <div class="muji-card grid-right-block">
                <div class="card-label">æç›Šè©¦ç®—è¡¨</div>
                <div class="table-wrapper auto-height"><table id="table-profit" class="muji-table"></table></div>
            </div>

            <div class="muji-card grid-full-width">
                <div class="card-label">é¡¯åŒ–å†¥æƒ³</div>
                <ul class="journal-list" id="list-manifestation"><li style="color:#ccc; text-align:center;">è®€å–ä¸­...</li></ul>
            </div>
            <div class="muji-card grid-full-width">
                <div class="card-label">æŠ•è³‡è¨ˆç®—è¡¨</div>
                <div class="table-wrapper scrollable"><table id="table-invest-calc" class="muji-table"></table></div>
            </div>
        </div>
      </div>
      <div id="tab-journal" class="tab-content">
        <div class="muji-title">é¡¯åŒ–æ—¥è¨˜</div>
        <div class="operation-container">
          <div style="padding: 0 10px;">
            <button class="journal-section-btn" onclick="openJournalModal('start')"><span>ä¸€æ—¥ä¹‹å§‹</span> <span class="material-icons-round">chevron_right</span></button>
            <button class="journal-section-btn" onclick="openJournalModal('middle')"><span>ä¸€æ—¥ä¹‹ä¸­ (ç›¤ä¸­ç´€éŒ„)</span> <span class="material-icons-round">chevron_right</span></button>
            <button class="journal-section-btn" onclick="openJournalModal('end')"><span>ä¸€æ—¥ä¹‹æœ«</span> <span class="material-icons-round">chevron_right</span></button>
          </div>
        </div>
      </div>
    </main>
    <nav class="bottom-nav">
      <button onclick="switchTab('tab-operation')" class="nav-btn" id="nav-operation"><span class="material-icons-round">trending_up</span></button>
      <button onclick="switchTab('tab-dashboard')" class="nav-btn active" id="nav-dashboard"><span class="material-icons-round">home</span></button>
      <button onclick="switchTab('tab-journal')" class="nav-btn" id="nav-journal"><span class="material-icons-round">auto_stories</span></button>
    </nav>
    <div id="expense-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3>æ–°å¢æ”¶æ”¯</h3><span class="material-icons-round close-btn" onclick="closeModal()">close</span></div><form id="modal-form"><div class="input-group"><label>é‡‘é¡</label><input type="number" id="amount" required placeholder="0" inputmode="decimal" style="font-size: 1.5rem; text-align: center;"></div><div class="input-group"><label>æ¶ˆè²»æ–¹å¼</label><div class="chip-group"><label class="muji-chip"><input type="radio" name="paymentMethod" value="ç¾é‡‘" checked><span>ç¾é‡‘</span></label><label class="muji-chip"><input type="radio" name="paymentMethod" value="æ‚ éŠå¡"><span>æ‚ éŠå¡</span></label><label class="muji-chip"><input type="radio" name="paymentMethod" value="å°æ–°Gogoro"><span>å°æ–°Gogoro</span></label><label class="muji-chip"><input type="radio" name="paymentMethod" value="å¯Œé‚¦Jå¡"><span>å¯Œé‚¦Jå¡</span></label><label class="muji-chip"><input type="radio" name="paymentMethod" value="ä¸­ä¿¡å¡"><span>ä¸­ä¿¡å¡</span></label><label class="muji-chip"><input type="radio" name="paymentMethod" value="ç‰å±±å¡"><span>ç‰å±±å¡</span></label><label class="muji-chip"><input type="radio" name="paymentMethod" value="æ–°å…‰å¡"><span>æ–°å…‰å¡</span></label><label class="muji-chip"><input type="radio" name="paymentMethod" value="å…†è±å¡"><span>å…†è±å¡</span></label><label class="muji-chip"><input type="radio" name="paymentMethod" value="ä¸²æš«æ¬ "><span>ä¸²æš«æ¬ </span></label></div></div><div class="input-group" style="display:flex; justify-content:space-between; align-items:center;"><label style="margin:0;">æ¶ˆè²»æ‹†åˆ†?</label><label class="switch"><input type="checkbox" id="isSplit" onchange="toggleSplitOptions()"><span class="slider round"></span></label></div><div id="split-section" style="display:none; background:#fafafa; padding:10px; border:1px solid #eee; margin-bottom:15px;"><div class="input-group"><label>æ‹†åˆ†æ–¹å¼</label><select id="splitMethod" onchange="toggleSplitInputs()"><option value="ä¸€äººä¸€åŠ">ä¸€äººä¸€åŠ</option><option value="æ½˜å…¨é¡">æ½˜å…¨é¡</option><option value="æ½˜éƒ¨åˆ†">æ½˜éƒ¨åˆ†</option><option value="ä»–äºº">ä»–äºº</option></select></div><div id="input-pan-part" class="input-group" style="display:none;"><label>æ½˜ éƒ¨ä»½é‡‘é¡</label><input type="number" id="panAmount"></div><div id="input-others" class="input-group" style="display:none;"><label>ä»–äºº é‡‘é¡</label><input type="number" id="othersAmount"></div><div id="input-chuan-pay" class="input-group" style="display:none;"><label>ä¸² æ”¯ä»˜ (é¸å¡«)</label><input type="number" id="chuanPay" placeholder="0"></div></div><div class="input-group" style="display:flex; align-items:center; gap:10px;"><input type="checkbox" id="isTobacco" style="width:auto;"><label for="isTobacco" style="margin:0;">æ˜¯å¦å«è¸</label></div><div class="input-group"><label>å‚™è¨»</label><input type="text" id="note"></div><button type="button" class="btn-muji" onclick="submitModalExpense()">ç¢ºèªå„²å­˜</button></form></div></div>
    <div id="modal-start" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3>ä¸€æ—¥ä¹‹å§‹</h3><span class="material-icons-round close-btn" onclick="closeJournalModal('start')">close</span></div><form onsubmit="submitJournalPart('start'); return false;"><div class="input-group"><label>æ—¥æœŸ</label><input type="date" id="j_date_start" required></div><div class="input-group"><label>ä»Šæ—¥ç›®æ¨™</label><input type="text" id="j_q3"></div><div class="input-group"><label>æ˜¯å¦èƒ½éœå¿ƒçœ‹ç›¤</label><select id="j_q4"><option value="æ˜¯">æ˜¯</option><option value="å¦">å¦</option></select></div><button type="submit" class="btn-muji">å„²å­˜</button></form></div></div>
    <div id="modal-middle" class="modal-overlay"><div class="modal-content" style="max-height:85vh; overflow-y:auto;"><div class="modal-header"><h3>ä¸€æ—¥ä¹‹ä¸­</h3><span class="material-icons-round close-btn" onclick="closeJournalModal('middle')">close</span></div><form onsubmit="submitJournalPart('middle'); return false;"><div class="input-group"><label>æ—¥æœŸ</label><input type="date" id="j_date_middle" required></div><div class="input-group"><label>æ˜¯å¦é€²è¡Œäº¤æ˜“</label><select id="j_q5"><option value="å¦">å¦</option><option value="è²·é€²">è²·é€²</option><option value="è³£å‡º">è³£å‡º</option><option value="ç•¶æ²–">ç•¶æ²–</option></select></div><hr style="border:0; border-top:1px dashed #eee; margin:15px 0;"><h4 style="margin:0 0 10px; color:#666;">å¸³æˆ¶ç´€éŒ„</h4><div class="flex-row"><div class="flex-col input-group"><label>å¸³é¢é‡‘é¡</label><input type="number" id="j_q6"></div><div class="flex-col input-group"><label>æˆæœ¬</label><input type="number" id="j_q7"></div></div><div class="flex-row"><div class="flex-col input-group"><label>æ·¨åˆ©%</label><input type="number" id="j_q8" step="0.01"></div><div class="flex-col input-group"><label>éŠ€è¡Œé¤˜é¡</label><input type="number" id="j_q9"></div></div><hr style="border:0; border-top:1px dashed #eee; margin:15px 0;"><h4 style="margin:0 0 10px; color:#666;">å¤§ç›¤ç´€éŒ„</h4><div class="input-group"><label>ä»Šæ—¥å¤§äº‹ä»¶</label><input type="text" id="j_q10"></div><div class="flex-row"><div class="flex-col input-group"><label>å¤§ç›¤æŒ‡æ•¸</label><input type="number" id="j_q11"></div><div class="flex-col input-group"><label>æ¼²è·Œ%</label><input type="number" id="j_q12" step="0.01"></div></div><button type="submit" class="btn-muji">å„²å­˜</button></form></div></div>
    
    <div id="modal-end" class="modal-overlay">
        <div class="modal-content" style="max-height:90vh; overflow-y:auto;">
            <div class="modal-header"><h3>ä¸€æ—¥ä¹‹æœ«</h3><span class="material-icons-round close-btn" onclick="closeJournalModal('end')">close</span></div>
            <form onsubmit="submitJournalPart('end'); return false;">
                <div class="input-group"><label>æ—¥æœŸ</label><input type="date" id="j_date_end" required></div>

                <div style="margin-bottom:15px; background:#fafafa; padding:10px; border-radius:4px;">
                      <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.8rem; color: #888;">
                        <span>ä¿®ç…‰å®Œæˆåº¦</span>
                        <span id="progress-text" style="font-weight: bold; color: var(--muji-red);">0%</span>
                      </div>
                      <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                        <div id="daily-progress-bar" style="width: 0%; height: 100%; background: var(--muji-red); transition: width 0.3s ease;"></div>
                      </div>
                </div>

                <div class="routine-wrapper" style="margin-bottom: 20px;">
                    <div style="background-color: #fafafa; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                        <div class="toggle-row" style="border-bottom: none; margin-bottom: 0;">
                            <span style="font-weight: 600; color: var(--muji-red); font-size: 0.9rem;">ä»Šæ—¥æ˜¯éŒ„å½±æ—¥ (Plan B)ï¼Ÿ</span>
                            <label class="switch">
                                <input type="checkbox" id="is_recording_day">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 5px;">*é–‹å•Ÿå¾Œï¼Œé‹å‹•èˆ‡ä¿é¤Šå°‡é€²å…¥ç°¡åŒ–æ¨¡å¼ã€‚</div>
                    </div>

                    <div class="routine-section">
                        <div class="routine-header">DAILY REVIEW</div>
                        <div class="input-group">
                            <label>ä»Šæ—¥æˆ‘çš„äº‹ä»¶</label>
                            <input type="text" id="j_q89">
                        </div>
                        <div class="input-group">
                            <label>ä»Šæ—¥èƒ½é‡/æ„Ÿå—</label>
                            <input type="text" id="j_q91">
                        </div>
                    </div>

                    <div class="routine-section" id="section-wealth">
                        <div class="routine-header">WEALTH & MANIFESTATION</div>
                        <div class="input-group">
                            <label id="lbl_wealth_evidence">ğŸ’° é‡‘éŒ¢é¡¯åŒ–</label>
                            <textarea id="wealth_evidence" rows="2" placeholder="..."></textarea>
                        </div>
                        <div class="input-group" id="wrapper-invest">
                            <label id="lbl_invest_practice">ğŸ“ˆ æŠ•è³‡å¯¦æˆ°</label>
                            <div class="chip-group" id="invest-chips" style="margin-bottom: 8px;">
                                </div>
                            <input type="text" id="invest_practice" placeholder="æ‰‹å‹•è£œå……...">
                        </div>
                    </div>

                    <div class="routine-section">
                        <div class="routine-header">CAREER REVIEW</div>
                        <div class="input-group">
                            <label id="lbl_career_people">ã€äººã€‘æºé€š</label>
                            <input type="text" id="career_people" placeholder="...">
                        </div>
                        <div class="input-group">
                            <label id="lbl_career_incident">ã€äº‹ã€‘çªç™¼</label>
                            <input type="text" id="career_incident" placeholder="...">
                        </div>
                        <div class="input-group">
                            <label id="lbl_career_next_focus">ã€é€²åº¦ã€‘ç„¦é»</label>
                            <input type="text" id="career_next_focus" placeholder="..." style="border-color: var(--muji-red);">
                        </div>
                    </div>

                    <div class="routine-section" id="section-health">
                        <div class="routine-header">HEALTH & SKILLS</div>
                        <div class="chip-group" id="health-chips-container" style="margin-bottom: 15px;">
                            <label class="muji-chip"><input type="checkbox" id="check_duolingo"><span id="lbl_check_duolingo">æ—¥æ–‡</span></label>
                            <label class="muji-chip"><input type="checkbox" id="check_reading"><span id="lbl_check_reading">é–±è®€</span></label>
                        </div>
                        <div class="input-group">
                            <label id="lbl_sport_execution">é‹å‹•åŸ·è¡Œ</label>
                            <select id="sport_execution" class="mini-select">
                                <option value="">æœªåŸ·è¡Œ</option>
                                <option value="Plan B">Plan B</option>
                                </select>
                        </div>
                        <div class="input-group">
                            <label id="lbl_beauty_routine">ç¾å®¹ä¿é¤Š</label>
                            <select id="beauty_routine" class="mini-select">
                                <option value="">æœªåŸ·è¡Œ</option>
                                <option value="Booster Pro">Booster Pro</option>
                                <option value="Hair/Foot">æ´—é«®æ³¡è…³</option>
                                <option value="Plan B">åŸºç¤æ¸…æ½”</option>
                            </select>
                        </div>
                    </div>

                    <div class="routine-section" id="section-declutter">
                        <div class="routine-header">DECLUTTER</div>
                        <div class="flex-row">
                            <div class="flex-col input-group">
                                <label id="lbl_declutter_item">ä¸Ÿæ£„ç‰©å“</label>
                                <input type="text" id="declutter_item" placeholder="...">
                            </div>
                            <div class="flex-col input-group">
                                <label id="lbl_declutter_area">æ•´ç†å€åŸŸ</label>
                                <select id="declutter_area" class="mini-select">
                                    <option value="tops">ä¸Šè¡£é¡</option>
                                    <option value="others">å…¶ä»–</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="routine-section">
                        <div class="routine-header" style="color: #d35400;">é¡¯åŒ–æ—¥è¨˜</div>
                        <div class="input-group"><label>æ„Ÿè¬ä¸€åˆ‡,æˆ‘åœ¨...</label><input type="text" id="j_q93"></div>
                        <div class="input-group"><label>ä¹‹å‰...</label><input type="text" id="j_q94"></div>
                        <div class="input-group"><label>æˆ‘æ„Ÿè¦º...</label><input type="text" id="j_q95"></div>
                        <div class="input-group"><label>ä¸¦ä¸”æˆ‘...</label><input type="text" id="j_q96"></div>
                        <div class="input-group"><label>æœ€å¾Œæˆ‘æƒ³...(æ„Ÿè¬)</label><input type="text" id="j_q97"></div>
                        
                        <div class="input-group">
                            <label style="color: #555; font-weight:bold;">å®Œæˆç›®æ¨™çš„æˆ‘ä»Šå¤©æœƒåšä»€éº¼</label>
                            <input type="text" id="j_q98" placeholder="å¯«å…¥ 'ç´€éŒ„'!X:X">
                        </div>
                        <div class="input-group">
                            <label style="color: #555; font-weight:bold;">æ˜æ—¥æœŸæœ›/å¾…è¾¦</label>
                            <input type="text" id="j_q99" placeholder="å¯«å…¥ 'ç´€éŒ„'!Y:Y">
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn-muji">æäº¤ä¸€æ—¥ç¸½çµ</button>
            </form>
        </div>
    </div>
    
    <div id="toast">å·²å„²å­˜</div>
    
    <script>
      const GAS_URL = "https://script.google.com/macros/s/AKfycbyLdqJ5ptuIscFyqh96me5c2en0lA8hz_dwJ9MW0WYiFY9KSpbvqNUniuLJf1TSyHU/exec"; 

      const firebaseConfig = { apiKey: "AIzaSyAa57KrUxbmw4k1YFDuEuREPmmYXhrNRGY", authDomain: "manifestation-fc95b.firebaseapp.com", databaseURL: "https://manifestation-fc95b-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "manifestation-fc95b", storageBucket: "manifestation-fc95b.firebasestorage.app", messagingSenderId: "330306956614", appId: "1:330306956614:web:482c539a49d63dfc34c947", measurementId: "G-2J15VBFWGG" };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      
      window.onload = function() {
        updateDate(); getWeather(); setupDashboardListener(); 
        setupMidnightRefresh(); 
        
        fetchCurrentMission();

        var today = new Date();
        if(document.getElementById('s_date')) document.getElementById('s_date').valueAsDate = today;
        if(document.getElementById('d_date')) document.getElementById('d_date').valueAsDate = today;
        if(document.getElementById('j_date_start')) document.getElementById('j_date_start').valueAsDate = today;
        if(document.getElementById('j_date_middle')) document.getElementById('j_date_middle').valueAsDate = today;
        if(document.getElementById('j_date_end')) document.getElementById('j_date_end').valueAsDate = today;
        if(document.getElementById('s_action')) updateReasonOptions();
        if(document.getElementById('d_trend')) updateDayTradeReason();
        
        document.querySelectorAll('#modal-end input, #modal-end select, #modal-end textarea').forEach(el => {
            el.addEventListener('input', updateProgress);
            el.addEventListener('change', updateProgress);
        });
        
        document.getElementById('is_recording_day').addEventListener('change', function() {
            autoSelectRoutine();
        });
      };

      function setupMidnightRefresh() {
          const now = new Date();
          const night = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0); 
          const msToMidnight = night.getTime() - now.getTime();

          setTimeout(function() {
              console.log("Midnight! Refreshing data...");
              updateDate(); 
              loadDashboardFromFirebase(); 
              setupMidnightRefresh(); 
          }, msToMidnight);
      }

      function autoSelectRoutine() {
        const isRecording = document.getElementById('is_recording_day').checked;
        const beautySelect = document.getElementById('beauty_routine');
        const investWrapper = document.getElementById('wrapper-invest');
        const declutterSection = document.getElementById('section-declutter');
        const sportSelect = document.getElementById('sport_execution');
        
        if (isRecording) {
            // éŒ„å½±æ—¥ï¼šé–å®šæŠ•è³‡èˆ‡æ–·æ¨é›¢ï¼Œä½†é‹å‹•ä¿ç•™
            if(investWrapper) investWrapper.classList.add('disabled-zone');
            if(declutterSection) declutterSection.classList.add('disabled-zone');
            
            if(investWrapper) investWrapper.querySelectorAll('input').forEach(el => el.disabled = true);
            if(declutterSection) declutterSection.querySelectorAll('input, select').forEach(el => el.disabled = true);

            beautySelect.value = 'Plan B';
            showToast("éŒ„å½±æ—¥ï¼šå·²é–å®šç°¡åŒ–æ¨¡å¼");
        } else {
            // æ¢å¾©
            if(investWrapper) investWrapper.classList.remove('disabled-zone');
            if(declutterSection) declutterSection.classList.remove('disabled-zone');
            
            if(investWrapper) investWrapper.querySelectorAll('input').forEach(el => el.disabled = false);
            if(declutterSection) declutterSection.querySelectorAll('input, select').forEach(el => el.disabled = false);
            
            beautySelect.value = ""; 
        }
        updateProgress();
      }

      function fetchCurrentMission() {
        if(GAS_URL.includes("ä½ çš„_SCRIPT_ID")) return;
        fetch(GAS_URL + "?action=getMission") 
        .then(response => response.json())
        .then(data => {
            let cycleText = `Cycle ${data.cycle_id || '?'}`;
            if(data.cycle_range) cycleText += ` (${data.cycle_range})`;
            document.getElementById('cycle-id').innerText = cycleText;

            document.getElementById('goal-year').innerText = data.year_goal || 'å°šæœªè¨­å®šå¹´åº¦ç›®æ¨™';
            document.getElementById('goal-season').innerText = data.season_goal || 'å°šæœªè¨­å®šå­£åº¦ç›®æ¨™';
            document.getElementById('goal-weekly').innerText = data.cycle_goal || 'å°šæœªè¨­å®šå‘¨ç›®æ¨™';

            document.getElementById('goal-career').innerText = data.career || '-';
            document.getElementById('goal-health').innerText = data.health || '-';
            document.getElementById('goal-wealth').innerText = data.wealth || '-';
            document.getElementById('goal-skills').innerText = data.skills || '-';
            document.getElementById('goal-life').innerText = data.life || '-';
            
            if(data.questions && data.questions.length > 0) {
                applyFormConfig(data.questions);
            }
        })
        .catch(err => {
            console.error("ç„¡æ³•è®€å–ç›®æ¨™", err);
        });
      }
      
      function toggleText(el) {
          el.classList.toggle('expanded');
      }

      function applyFormConfig(questions) {
         questions.forEach(q => {
             var el = document.getElementById(q.id);
             var labelEl = document.getElementById("lbl_" + q.id);
             
             if(labelEl) labelEl.innerText = q.label;
             if(el && q.placeholder) el.placeholder = q.placeholder;

             if (q.options && q.options.length > 0) {
                 if (el && el.tagName === 'SELECT') {
                     // ç‰¹åˆ¥è™•ç†ï¼šä¿ç•™ "æœªåŸ·è¡Œ" é¸é …ï¼Œç„¶å¾ŒåŠ å…¥å¾Œç«¯ä¾†çš„é¸é …
                     // å¦‚æœæ˜¯é‹å‹•é¸å–®ï¼Œæˆ‘å€‘ä¿ç•™ Plan B
                     var keepPlanB = (q.id === 'sport_execution');
                     el.innerHTML = '<option value="">æœªåŸ·è¡Œ</option>' + (keepPlanB ? '<option value="Plan B">Plan B</option>' : '');
                     q.options.forEach(opt => {
                         if (opt !== 'Plan B') { // é¿å…é‡è¤‡
                             var option = document.createElement("option");
                             option.value = opt;
                             option.innerText = opt;
                             el.appendChild(option);
                         }
                     });
                 } else if (q.id === 'invest_practice') {
                     var chipContainer = document.getElementById('invest-chips');
                     chipContainer.innerHTML = '';
                     q.options.forEach(opt => {
                         var label = document.createElement("label");
                         label.className = "muji-chip";
                         label.innerHTML = `<input type="checkbox" onchange="updateInvestInput(this)" value="${opt}"><span>${opt}</span>`;
                         chipContainer.appendChild(label);
                     });
                 }
             }
         });
      }

      function updateProgress() {
        const isRecording = document.getElementById('is_recording_day').checked;
        let total = 6; 
        
        if (isRecording) {
            total = 4;
        }

        let completed = 0;
        
        // è·æ¥­
        if (document.getElementById('career_people').value && document.getElementById('career_next_focus').value) completed++;
        
        // å¥åº· (ä¿®æ­£ï¼šå¦‚æœæ˜¯éŒ„å½±æ—¥ï¼Œåªçœ‹é‹å‹•æ˜¯å¦æœ‰å¡«)
        if (isRecording) {
             if (document.getElementById('sport_execution').value) completed++;
        } else {
             if (document.getElementById('sport_execution').value) completed++;
             if (document.getElementById('check_duolingo').checked && document.getElementById('check_reading').checked) completed = Math.min(total, completed + 0.5); 
        }
        
        if (document.getElementById('beauty_routine').value) completed++;
        
        if (document.getElementById('wealth_evidence').value) completed++;
        
        if (!isRecording) {
            if (document.getElementById('invest_practice').value) completed++;
            if (document.getElementById('declutter_item').value) completed++;
        }

        let percent = (total === 0) ? 0 : Math.floor((completed / total) * 100);
        document.getElementById('daily-progress-bar').style.width = percent + "%";
        document.getElementById('progress-text').innerText = percent + "%";
        return percent;
      }
      
      function updateInvestInput(checkbox) {
        const input = document.getElementById('invest_practice');
        let currentVals = input.value ? input.value.split(', ') : [];
        if (checkbox.checked) {
            if (!currentVals.includes(checkbox.value)) currentVals.push(checkbox.value);
        } else {
            currentVals = currentVals.filter(v => v !== checkbox.value);
        }
        input.value = currentVals.join(', ');
        updateProgress();
      }

      function setupDashboardListener() {
        loadDashboardFromFirebase(); 

        db.ref('system/lastUpdate').on('value', (snapshot) => {
            const timestamp = snapshot.val();
            if(timestamp) {
                console.log("æ”¶åˆ°æ›´æ–°ä¿¡è™Ÿ:", timestamp);
                loadDashboardFromFirebase(); 
            }
        });
      }

      function loadDashboardFromFirebase() {
        if(document.getElementById('daily-quote')) document.getElementById('daily-quote').innerText = "é›²ç«¯åŒæ­¥ä¸­...";
        
        db.ref('dashboard').once('value').then((snapshot) => {
            const data = snapshot.val();
            if (data) {
                renderDashboard(data);
                if(document.getElementById('daily-quote')) document.getElementById('daily-quote').style.color = "var(--accent-brown)"; 
            } else {
                document.getElementById('daily-quote').innerText = "ç„¡è³‡æ–™";
            }
        }).catch((error) => {
            console.error("Firebase:", error);
            document.getElementById('daily-quote').innerText = "è®€å–å¤±æ•—";
        });
      }

      function renderDashboard(data) {
            if(!data) return;
            if(document.getElementById('today-expense')) document.getElementById('today-expense').innerText = (data.todayExpense || 0).toLocaleString();
            if(document.getElementById('month-expense')) document.getElementById('month-expense').innerText = data.monthExpense;
            if(document.getElementById('daily-quote')) document.getElementById('daily-quote').innerText = data.quote;
            if(document.getElementById('goal-display')) document.getElementById('goal-display').innerText = data.goalText || "å°šç„¡ç›®æ¨™"; 
            renderTable(data.investCalcData, 'table-invest-calc');
            renderTable(data.profitData, 'table-profit');
            
            var calList = document.getElementById('calendar-list');
            if(calList && data.calendarEvents) {
                calList.innerHTML = '';
                if(data.calendarEvents.length === 0) {
                    calList.innerHTML = '<li style="color:#ccc; justify-content:center;">æš«ç„¡è¡Œç¨‹</li>';
                } else {
                    var now = new Date();
                    var tStr = (now.getMonth() + 1) + "/" + now.getDate();
                    var max = 5; 
                    data.calendarEvents.slice(0, max).forEach(evt => {
                        var li = document.createElement('li');
                        var isT = evt.date.indexOf(tStr) === 0;
                        var w = isT ? "bold" : "normal";
                        var c = isT ? "#333" : "#555";
                        var dc = isT ? "#d35400" : "var(--accent-brown)";
                        var dt = isT ? "TODAY" : evt.date;
                        var bs = evt.color ? `border-left: ${isT?'6px':'4px'} solid ${evt.color}; padding-left: 8px;` : '';
                        li.style.padding = "8px 0 8px 5px";
                        if(isT) li.style.backgroundColor = "#fafafa";
                        li.innerHTML = `<div style="display:flex; align-items:center; width:100%; ${bs}"><span class="cal-date" style="min-width: 60px; color:${dc}; font-weight:${w};">${dt}</span><span class="cal-title-wrapper" style="color:${c}; font-weight:${w};">${evt.title}</span></div>`;
                        calList.appendChild(li);
                    });
                    if(data.calendarEvents.length > max) {
                        var more = document.createElement('li');
                        more.innerHTML = `é‚„æœ‰ ${data.calendarEvents.length - max} å€‹è¡Œç¨‹...`;
                        more.style.cssText = "color:#ccc; text-align:center; border:none; font-size:0.8rem;";
                        calList.appendChild(more);
                    }
                }
            } else if(calList) { calList.innerHTML = '<li style="color:#ccc; justify-content:center;">æš«ç„¡è¡Œç¨‹</li>'; }

            var miniGratList = document.getElementById('mini-gratitude-list');
            if (miniGratList) {
                miniGratList.innerHTML = '';
                if (!data.gratitudeList || Object.keys(data.gratitudeList).length === 0) {
                    miniGratList.innerHTML = '<li style="color:#ccc; text-align:center;">ç„¡è³‡æ–™</li>';
                } else {
                    var listArray = Array.isArray(data.gratitudeList) ? data.gratitudeList : Object.values(data.gratitudeList);
                    listArray.sort((a, b) => new Date(a.date) - new Date(b.date));
                    var recentItems = listArray.slice(-5);
                    
                    recentItems.forEach(item => { 
                        var li = document.createElement('li'); 
                        var shortDate = (item.date && item.date.length >= 5) ? item.date.substring(5) : item.date;
                        li.innerHTML = `<span class="date">${shortDate}</span> ${item.content}`; 
                        miniGratList.appendChild(li); 
                    });
                }
            }
            var maniList = document.getElementById('list-manifestation');
            if (maniList) {
                maniList.innerHTML = '';
                if (!data.manifestationList || data.manifestationList.length === 0) maniList.innerHTML = '<li style="color:#ccc; text-align:center;">ç„¡è³‡æ–™</li>';
                else data.manifestationList.forEach(item => { var li = document.createElement('li'); li.innerHTML = `<span class="journal-meta">${item.date}</span> ${item.content}`; maniList.appendChild(li); });
            }
      }
      function pushToFirebaseQueue(taskType, taskData, successMsg, callback) {
          showToast("è™•ç†ä¸­...");
          db.ref('request_queue').push({ type: taskType, timestamp: new Date().toISOString(), ...taskData }).then(() => { showToast(successMsg || "å·²ç´€éŒ„"); if (callback) callback(); }).catch(error => alert("å¯«å…¥å¤±æ•—: " + error.message));
      }
      
      function submitModalExpense() { 
        var btn = document.querySelector('#modal-form .btn-muji'); btn.disabled = true;
        var isSplitChecked = document.getElementById('isSplit').checked;
        var splitMethod = isSplitChecked ? document.getElementById('splitMethod').value : "";
        var panAmount = (splitMethod === "æ½˜éƒ¨åˆ†") ? document.getElementById('panAmount').value : "";
        
        var formData = { 
            amount: document.getElementById('amount').value, 
            paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value, 
            isSplit: isSplitChecked ? "æ˜¯" : "", 
            isTobacco: document.getElementById('isTobacco').checked ? "æ˜¯" : "", 
            splitMethod: splitMethod, 
            panAmount: panAmount, 
            othersAmount: document.getElementById('othersAmount').value, 
            chuanPay: document.getElementById('chuanPay').value, 
            note: document.getElementById('note').value 
        }; 
        pushToFirebaseQueue('expense', formData, "å·²è¨˜å¸³", () => { closeModal(); document.getElementById('modal-form').reset(); btn.disabled = false; let current = parseFloat(document.getElementById('today-expense').innerText.replace(/,/g,'')) || 0; document.getElementById('today-expense').innerText = (current + (parseFloat(formData.amount)||0)).toLocaleString(); });
      }

      function submitGratitude() { 
        var btn = event.target; 
        btn.disabled = true; 
        var content = document.getElementById('journal-text').value; 
        var today = new Date().toISOString().substring(0, 10);
        pushToFirebaseQueue('journal', { journalType: 'gratitude', content: content, date: today }, "å·²ä¿å­˜", () => { document.getElementById('journal-text').value = ""; btn.disabled = false; }); 
      }
      
      function submitJournalPart(type) { 
        var btn = document.querySelector('#modal-' + type + ' button[type="submit"]'); 
        btn.disabled = true; 
        var data = { journalType: type }; 
        
        if (type === 'start') { 
            data.date = document.getElementById('j_date_start').value;
            data.q3 = document.getElementById('j_q3').value; 
            data.q4 = document.getElementById('j_q4').value; 
            pushToFirebaseQueue('journal', data, "ä¸€æ—¥ä¹‹å§‹å·²ç´€éŒ„", () => { closeJournalModal(type); btn.disabled = false; });
        } 
        else if (type === 'middle') { 
            data.date = document.getElementById('j_date_middle').value;
            data.q5 = document.getElementById('j_q5').value; 
            data.q6 = document.getElementById('j_q6').value; 
            data.q7 = document.getElementById('j_q7').value; 
            data.q8 = document.getElementById('j_q8').value; 
            data.q9 = document.getElementById('j_q9').value; 
            data.q10 = document.getElementById('j_q10').value; 
            data.q11 = document.getElementById('j_q11').value; 
            data.q12 = document.getElementById('j_q12').value; 
            pushToFirebaseQueue('journal', data, "ç›¤ä¸­ç´€éŒ„å·²ç´€éŒ„", () => { closeJournalModal(type); btn.disabled = false; });
        } 
        // èˆŠç‰ˆ "end" å·²åˆªé™¤ï¼Œæ–°çš„æ•´åˆç‰ˆé‚è¼¯å¦‚ä¸‹ï¼š
        else if (type === 'end') { 
            // 1. æº–å‚™ Daily Routine æ•¸æ“š (å°æ‡‰ Practice Report)
            var routineData = {
              date: document.getElementById('j_date_end').value,
              is_recording: document.getElementById('is_recording_day').checked ? "æ˜¯" : "å¦",
              career_review: `ã€äººã€‘${document.getElementById('career_people').value} | ã€äº‹ã€‘${document.getElementById('career_incident').value || 'ç„¡'} | ã€ç„¦é»ã€‘${document.getElementById('career_next_focus').value}`,
              health_status: `é‹å‹•:${document.getElementById('sport_execution').value} | ä¿é¤Š:${document.getElementById('beauty_routine').value}`,
              wealth_evidence: document.getElementById('wealth_evidence').value,
              invest_practice: document.getElementById('invest_practice').value,
              declutter_item: `${document.getElementById('declutter_item').value} (${document.getElementById('declutter_area').value})`,
              score: updateProgress() + "%",
              note: `${document.getElementById('j_q89').value} | æ„Ÿå—:${document.getElementById('j_q91').value}`, 
              streak: "Day 1"
            };

            // 2. æº–å‚™ Journal æ•¸æ“š (å°æ‡‰ é¡¯åŒ–æ—¥è¨˜)
            var journalData = {
                journalType: 'end',
                date: document.getElementById('j_date_end').value,
                q89: document.getElementById('j_q89').value, // ç‚ºäº†ç›¸å®¹ï¼Œé‡è¤‡é€å‡º
                q91: document.getElementById('j_q91').value,
                q93: document.getElementById('j_q93').value,
                q94: document.getElementById('j_q94').value,
                q95: document.getElementById('j_q95').value,
                q96: document.getElementById('j_q96').value,
                q97: document.getElementById('j_q97').value,
                q98: document.getElementById('j_q98').value,
                q99: document.getElementById('j_q99').value
            };

            btn.innerText = "å¯«å…¥ä¸­...";
            
            // åŒæ™‚é€å‡ºå…©å€‹è«‹æ±‚åˆ° Queue
            pushToFirebaseQueue('daily_routine', routineData, null, () => {
                pushToFirebaseQueue('journal', journalData, "ä¸€æ—¥ç¸½çµå·²æ­¸æª”ï¼", () => {
                    closeJournalModal(type); 
                    btn.disabled = false; 
                    btn.innerText = "æäº¤ä¸€æ—¥ç¸½çµ";
                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('modal-end').querySelectorAll('input[type="text"], textarea').forEach(el => el.value = "");
                    document.getElementById('modal-end').querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
                    document.getElementById('beauty_routine').selectedIndex = 0;
                    document.getElementById('sport_execution').selectedIndex = 0;
                    updateProgress();
                });
            });
        }
      }
      
      function resetGoalForm() {
         // æ­¤å‡½å¼å·²æ•´åˆé€² submitJournalPart('end') çš„ callback ä¸­ï¼Œä¿ç•™ç©ºå‡½å¼é¿å…å ±éŒ¯
      }

      function submitStock() { 
        var btn = document.querySelector('#form-swing .btn-muji'); 
        btn.disabled = true;
        var action = document.getElementById('s_action').value;
        var reason = document.getElementById('s_reason').value;
        
        var formData = { 
            date: document.getElementById('s_date').value, 
            code: document.getElementById('s_code').value, 
            name: document.getElementById('s_name').value, 
            shares: document.getElementById('s_shares').value, 
            price: document.getElementById('s_price').value, 
            settlement: document.getElementById('s_settlement').value, 
            trend: document.getElementById('s_trend').value, 
            action: action, 
            reason: reason, 
            weekTrend: document.getElementById('s_weekTrend').value, 
            dayTrend: document.getElementById('s_dayTrend').value, 
            position: document.getElementById('s_position').value, 
            volume: document.getElementById('s_volume').value, 
            ma20t: document.getElementById('s_ma20t').value, 
            maArrangement: document.getElementById('s_maArrangement').value, 
            kd: document.getElementById('s_kd').value, 
            macd: document.getElementById('s_macd').value, 
            pressure: document.getElementById('s_pressure').value, 
            support: document.getElementById('s_support').value 
        };
        
        pushToFirebaseQueue('stock', formData, "æ³¢æ®µç´€éŒ„å·²é€å‡º", () => { 
            backToSelection(); 
            document.getElementById('stockForm').reset();
            btn.disabled = false; 
            var today = new Date();
            if(document.getElementById('s_date')) document.getElementById('s_date').valueAsDate = today;
            if(document.getElementById('s_action')) updateReasonOptions();
        }); 
      }
      
      function submitDayTrade() { 
        var btn = document.querySelector('#form-daytrade .btn-muji'); 
        btn.disabled = true;
        var formData = {
            date: document.getElementById('d_date').value,
            code: document.getElementById('d_code').value,
            name: document.getElementById('d_name').value,
            trend: document.getElementById('d_trend').value,
            reason: document.getElementById('d_reason').value,
            prev20t: document.getElementById('d_prev20t').value,
            prevVol: document.getElementById('d_prevVol').value,
            prevKd: document.getElementById('d_prevKd').value,
            dayTrend: document.getElementById('d_dayTrend').value,
            trend15m: document.getElementById('d_trend15m').value,
            trend5m: document.getElementById('d_trend5m').value,
            shares: document.getElementById('d_shares').value,
            entryPrice: document.getElementById('d_entryPrice').value,
            realEntryPrice: document.getElementById('d_realEntryPrice').value,
            exitPrice: document.getElementById('d_exitPrice').value,
            realExitPrice: document.getElementById('d_realExitPrice').value,
            exitReason: document.getElementById('d_exitReason').value
        };
        pushToFirebaseQueue('daytrade', formData, "ç•¶æ²–å·²ç´€éŒ„", () => { 
            backToSelection(); 
            document.getElementById('dayTradeForm').reset();
            btn.disabled = false; 
            var today = new Date();
            if(document.getElementById('d_date')) document.getElementById('d_date').valueAsDate = today;
            updateDayTradeReason();
        }); 
      }
      function triggerManualSync() {
          loadDashboardFromFirebase();
          showToast("æ­£åœ¨é‡æ–°æ•´ç†è³‡æ–™...");
          if (typeof google !== 'undefined' && google.script) {
              google.script.run.syncDashboardToFirebase();
          }
      }
      function switchTab(tabId) { var contents = document.getElementsByClassName('tab-content'); for (var i = 0; i < contents.length; i++) contents[i].classList.remove('active'); var navs = document.getElementsByClassName('nav-btn'); for (var j = 0; j < navs.length; j++) navs[j].classList.remove('active'); document.getElementById(tabId).classList.add('active'); var navId = 'nav-' + tabId.replace('tab-', ''); if(document.getElementById(navId)) document.getElementById(navId).classList.add('active'); if (tabId === 'tab-operation') { backToSelection(); var today = new Date(); if(!document.getElementById('s_date').value) document.getElementById('s_date').valueAsDate = today; if(!document.getElementById('d_date').value) document.getElementById('d_date').valueAsDate = today; } }
      function selectMode(mode) { document.getElementById('op-selection').classList.add('hidden'); if (mode === 'swing') document.getElementById('form-swing').classList.remove('hidden'); else document.getElementById('form-daytrade').classList.remove('hidden'); }
      function backToSelection() { document.getElementById('op-selection').classList.remove('hidden'); document.getElementById('form-swing').classList.add('hidden'); document.getElementById('form-daytrade').classList.add('hidden'); }
      function updateDate() { var now = new Date(); document.getElementById('header-date').innerText = (now.getMonth()+1) + '/' + now.getDate(); document.getElementById('header-day').innerText = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][now.getDay()]; }
      function getWeather() { fetch("https://api.open-meteo.com/v1/forecast?latitude=25.033&longitude=121.565&current_weather=true").then(r => r.json()).then(data => { var code = data.current_weather.weathercode; var icon = (code > 3) ? (code > 50 ? "grain" : "cloud") : "wb_sunny"; document.getElementById('weather-display').innerHTML = `<span class="material-icons-round">${icon}</span> ${Math.round(data.current_weather.temperature)}Â°C`; }).catch(e => { document.getElementById('weather-display').innerText = "--"; }); }
      function openModal() { document.getElementById('expense-modal').classList.add('active'); }
      function closeModal() { document.getElementById('expense-modal').classList.remove('active'); }
      function openJournalModal(type) { 
          document.getElementById('modal-' + type).classList.add('active'); 
          // æ–°ç‰ˆåªæœ‰ end éœ€è¦ç‰¹åˆ¥è™•ç†
          if(type === 'end') { 
              // å¯ä»¥åœ¨é€™è£¡é‡ç½®é€²åº¦æ¢
              updateProgress();
          } 
      }
      function closeJournalModal(type) { document.getElementById('modal-' + type).classList.remove('active'); }
      function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 2000); }
      function toggleSplitOptions() { var isSplit = document.getElementById('isSplit').checked; document.getElementById('split-section').style.display = isSplit ? 'block' : 'none'; }
      function toggleSplitInputs() { var method = document.getElementById('splitMethod').value; document.getElementById('input-pan-part').style.display = method === 'æ½˜éƒ¨åˆ†' ? 'block' : 'none'; document.getElementById('input-others').style.display = method === 'ä»–äºº' ? 'block' : 'none'; document.getElementById('input-chuan-pay').style.display = 'block'; }
      function updateReasonOptions() { var action = document.getElementById('s_action').value; var reasonSelect = document.getElementById('s_reason'); var label = document.getElementById('reasonLabel'); reasonSelect.innerHTML = ""; if (action === "é€²å ´") { label.innerText = "é€²å ´æ¢ä»¶"; ["å¤šé ­ç¢ºèª", "ç©ºé ­ç¢ºèª", "å›å¾Œè²·ä¸Šæ¼²(éæ˜¨é«˜)", "å½ˆå¾Œç©ºä¸‹è·Œ(ç ´æ˜¨ä½)", "ç›¤æ•´çªç ´", "ç›¤æ•´è·Œç ´", "å‹æ…‹ç¢ºèª", "æ¶Vè½‰"].forEach(o => { var op = document.createElement("option"); op.value = o; op.innerText = o; reasonSelect.appendChild(op); }); } else { label.innerText = "å‡ºå ´åŸå› "; ["åœåˆ©", "åœæ", "é‡å£“", "é‡æ’"].forEach(o => { var op = document.createElement("option"); op.value = o; op.innerText = o; reasonSelect.appendChild(op); }); } }
      function updateDayTradeReason() { var trend = document.getElementById('d_trend').value; var reasonSelect = document.getElementById('d_reason'); reasonSelect.innerHTML = ""; var options = (trend === "å¤š") ? ["æ€¥æ¼²", "ç¬¬2æˆ–3å€‹é ­é ­é«˜", "å›æª”é‡æ”¯æ’", "Kç·šæ©«ç›¤", "çªç ´é•·æœŸä¸‹é™åˆ‡ç·š", "çªç ´ä¸Šå‡è»Œé“ç·š", "å¼·è¦†è“‹>è¦†è“‹>åå™¬>é­é‡", "æ¯å­æ‡·æŠ±", "è¦†è“‹è®Šå¤¾æ“Š", "ä¸€æ˜ŸäºŒé™½"] : ["æ€¥è·Œ", "ç¬¬2æˆ–3å€‹é ­é ­ä½", "ä¸Šæ¼²é‡å£“", "åå½ˆé‡å£“", "Kç·šæ©«ç›¤", "è·Œç ´é•·æœŸä¸Šå‡åˆ‡ç·š", "è·Œç ´ä¸‹é™è»Œé“ç·š", "å¼·è¦†è“‹>è¦†è“‹>åå™¬>é­é‡", "æ¯å­æ‡·æŠ±", "è¦†è“‹è®Šå¤¾æ“Š", "ä¸€æ˜ŸäºŒé™°"]; options.forEach(o => { var op = document.createElement("option"); op.value = o; op.innerText = o; reasonSelect.appendChild(op); }); }
      function renderTable(data, tableId) {
        var table = document.getElementById(tableId); if(!table) return; table.innerHTML = ''; 
        if (!data || data.length === 0) { table.innerHTML = '<tr><td>ç„¡è³‡æ–™</td></tr>'; return; }
        var isInvestTable = (tableId === 'table-invest-calc'); var isProfitTable = (tableId === 'table-profit'); var headerRowsCount = isProfitTable ? 2 : 1; var colorTargetIndices = [];
        if (isInvestTable && data.length > 0) data[0].forEach(function(h, idx) { var txt = (h || "").toString().trim(); if (txt.includes('ç•¶æ²–') || txt.includes('æ³¢æ®µ') || txt.includes('ç›ˆè™§') || txt.includes('ç¸½å’Œ')) colorTargetIndices.push(idx); });
        data.forEach(function(row, rowIndex) {
          if (!row || (Array.isArray(row) && row.join('').trim() === '')) return;
          var tr = document.createElement('tr');
          row.forEach(function(cell, colIndex) {
            var isHeader = (rowIndex < headerRowsCount); var td = document.createElement(isHeader ? 'th' : 'td'); 
            var cellText = (cell === null || cell === undefined) ? "" : cell.toString().trim();
            if (['0', '0.00', '0.00%', '0%', '-0'].includes(cellText)) td.innerText = ''; 
            else { td.innerText = cellText; if (isInvestTable && !isHeader && colorTargetIndices.includes(colIndex)) { var numVal = parseFloat(cellText.replace(/,/g, '').replace(/%/g, '')); if (!isNaN(numVal)) { if (numVal > 0) td.classList.add('text-pos'); if (numVal < 0) td.classList.add('text-neg'); } } }
            if (isInvestTable && !isHeader && /^[0-9,.\-%]+$/.test(cellText) && cellText !== '') td.classList.add('text-right');
            tr.appendChild(td);
          });
          table.appendChild(tr);
        });
        if (isProfitTable) applyProfitTableColoring(table);
      }
      function applyProfitTableColoring(table) {
          var rows = table.getElementsByTagName('tr'); var priceRowIndex = -1; var percentRowIndex = -1;
          for (var i = 0; i < rows.length; i++) { var headerText = rows[i].cells[0] ? rows[i].cells[0].innerText.trim() : ""; if (headerText === 'ç¾åƒ¹') priceRowIndex = i; if (headerText === '%') percentRowIndex = i; }
          if (priceRowIndex !== -1 && percentRowIndex !== -1) {
              var priceRow = rows[priceRowIndex]; var percentRow = rows[percentRowIndex];
              for (var j = 1; j < priceRow.cells.length; j++) {
                  var percentCell = percentRow.cells[j]; var priceCell = priceRow.cells[j];
                  if (percentCell && priceCell) { var val = parseFloat(percentCell.innerText.replace('%', '').trim()); if (!isNaN(val)) { if (val > 0) { percentCell.classList.add('text-pos'); priceCell.classList.add('text-pos'); } else if (val < 0) { percentCell.classList.add('text-neg'); priceCell.classList.add('text-neg'); } } }
              }
          }
      }
    </script>
</body>
</html>
